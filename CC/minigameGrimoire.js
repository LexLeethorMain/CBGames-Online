"use strict";(M={}).parent=Game.Objects["Wizard tower"],(M.parent.minigame=M).launch=function(){var r=this;r.name=r.parent.minigameName,r.init=function(e){r.spells={"conjure baked goods":{name:loc("Conjure Baked Goods"),desc:loc("Summon half an hour worth of your CpS, capped at %1% of your cookies owned.",15),failDesc:loc("Trigger a %1-minute clot and lose %1 minutes of CpS.",15),icon:[21,11],costMin:2,costPercent:.4,win:function(){var e=Math.max(7,Math.min(.15*Game.cookies,60*Game.cookiesPs*30));Game.Earn(e),Game.Notify(loc("Conjure Baked Goods")+(EN?"!":""),loc("You magic <b>%1</b> out of thin air.",loc("%1 cookie",LBeautify(e))),[21,11],6),Game.Popup('<div style="font-size:80%;">'+loc("+%1!",loc("%1 cookie",LBeautify(e)))+"</div>",Game.mouseX,Game.mouseY)},fail:function(){var e=Game.gainBuff("clot",900,.5),i=Math.min(.15*Game.cookies,60*Game.cookiesPs*15)+13,i=Math.min(Game.cookies,i);Game.Spend(i),Game.Notify(e.name,e.desc,e.icon,6),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Summoning failed!")+" "+loc("Lost %1!",loc("%1 cookie",LBeautify(i)))+"</div>",Game.mouseX,Game.mouseY)}},"hand of fate":{name:loc("Force the Hand of Fate"),desc:loc("Summon a random golden cookie. Each existing golden cookie makes this spell +%1% more likely to backfire.",15),failDesc:loc("Summon an unlucky wrath cookie."),icon:[22,11],costMin:10,costPercent:.6,failFunc:function(e){return e+.15*Game.shimmerTypes.golden.n},win:function(){var e=new Game.shimmer("golden",{noWrath:!0}),i=[];i.push("frenzy","multiply cookies"),Game.hasBuff("Dragonflight")||i.push("click frenzy"),Math.random()<.1&&i.push("cookie storm","cookie storm","blab"),10<=Game.BuildingsOwned&&Math.random()<.25&&i.push("building special"),Math.random()<.15&&(i=["cookie storm drop"]),Math.random()<1e-4&&i.push("free sugar lump"),e.force=choose(i),"cookie storm drop"==e.force&&(e.sizeMult=.75*Math.random()+.25),Game.Popup('<div style="font-size:80%;">'+loc("Promising fate!")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){var e=new Game.shimmer("golden",{wrath:!0}),i=[];i.push("clot","ruin cookies"),Math.random()<.1&&i.push("cursed finger","blood frenzy"),Math.random()<.003&&i.push("free sugar lump"),Math.random()<.1&&(i=["blab"]),e.force=choose(i),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Sinister fate!")+"</div>",Game.mouseX,Game.mouseY)}},"stretch time":{name:loc("Stretch Time"),desc:loc("All active buffs gain %1% more time (up to %2 more minutes).",[10,5]),failDesc:loc("All active buffs are shortened by %1% (up to %2 minutes shorter).",[20,10]),icon:[23,11],costMin:8,costPercent:.2,win:function(){var e,i=0;for(e in Game.buffs){var o=Game.buffs[e],a=Math.min(60*Game.fps*5,.1*o.maxTime);o.maxTime+=a,o.time+=a,i++}if(0==i)return Game.Popup('<div style="font-size:80%;">'+loc("No buffs to alter!")+"</div>",Game.mouseX,Game.mouseY),-1;Game.Popup('<div style="font-size:80%;">'+loc("Zap! Buffs lengthened.")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){var e,i=0;for(e in Game.buffs){var o=Game.buffs[e],a=Math.min(60*Game.fps*10,.2*o.time);o.time-=a,o.time=Math.max(o.time,0),i++}if(0==i)return Game.Popup('<div style="font-size:80%;">'+loc("No buffs to alter!")+"</div>",Game.mouseX,Game.mouseY),-1;Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Fizz! Buffs shortened.")+"</div>",Game.mouseX,Game.mouseY)}},"spontaneous edifice":{name:loc("Spontaneous Edifice"),desc:loc("The spell picks a random building you could afford if you had twice your current cookies, and gives it to you for free. The building selected must be under %1, and cannot be your most-built one (unless it is your only one).",400),failDesc:loc("Lose a random building."),icon:[24,11],costMin:20,costPercent:.75,win:function(){var e,i=[],o=0,a=0;for(e in Game.Objects)Game.Objects[e].amount>o&&(o=Game.Objects[e].amount),0<Game.Objects[e].amount&&a++;for(e in Game.Objects)(Game.Objects[e].amount<o||1==a)&&Game.Objects[e].getPrice()<=2*Game.cookies&&Game.Objects[e].amount<400&&i.push(Game.Objects[e]);if(0==i.length)return Game.Popup('<div style="font-size:80%;">'+loc("No buildings to improve!")+"</div>",Game.mouseX,Game.mouseY),-1;var t=choose(i);t.buyFree(1),Game.Popup('<div style="font-size:80%;">'+loc("A new %1<br>bursts out of the ground.",t.single)+"</div>",Game.mouseX,Game.mouseY)},fail:function(){if(0==Game.BuildingsOwned)return Game.Popup('<div style="font-size:80%;">'+loc("Backfired, but no buildings to destroy!")+"</div>",Game.mouseX,Game.mouseY),-1;var e,i=[];for(e in Game.Objects)0<Game.Objects[e].amount&&i.push(Game.Objects[e]);var o=choose(i);o.sacrifice(1),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("One of your %1<br>disappears in a puff of smoke.",o.plural)+"</div>",Game.mouseX,Game.mouseY)}},"haggler's charm":{name:loc("Haggler's Charm"),desc:loc("Upgrades are %1% cheaper for 1 minute.",2),failDesc:loc("Upgrades are %1% more expensive for an hour.",2)+(EN?"<q>What's that spell? Loadsamoney!</q>":""),icon:[25,11],costMin:10,costPercent:.1,win:function(){Game.killBuff("Haggler's misery"),Game.gainBuff("haggler luck",60,2),Game.Popup('<div style="font-size:80%;">'+loc("Upgrades are cheaper!")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){Game.killBuff("Haggler's luck"),Game.gainBuff("haggler misery",3600,2),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Upgrades are pricier!")+"</div>",Game.mouseX,Game.mouseY)}},"summon crafty pixies":{name:loc("Summon Crafty Pixies"),desc:loc("Buildings are %1% cheaper for 1 minute.",2),failDesc:loc("Buildings are %1% more expensive for an hour.",2),icon:[26,11],costMin:10,costPercent:.2,win:function(){Game.killBuff("Nasty goblins"),Game.gainBuff("pixie luck",60,2),Game.Popup('<div style="font-size:80%;">'+loc("Crafty pixies")+"<br>"+loc("Buildings are cheaper!")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){Game.killBuff("Crafty pixies"),Game.gainBuff("pixie misery",3600,2),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Nasty goblins")+"<br>"+loc("Buildings are pricier!")+"</div>",Game.mouseX,Game.mouseY)}},"gambler's fever dream":{name:loc("Gambler's Fever Dream"),desc:loc("Cast a random spell at half the magic cost, with twice the chance of backfiring."),icon:[27,11],costMin:3,costPercent:.05,win:function(){var e,i=[],o=r.getSpellCost(r.spells["gambler's fever dream"]);for(e in r.spells)"gambler's fever dream"!=e&&r.magic-o>=.5*r.getSpellCost(r.spells[e])&&i.push(r.spells[e]);if(0==i.length)return Game.Popup('<div style="font-size:80%;">'+loc("No eligible spells!")+"</div>",Game.mouseX,Game.mouseY),-1;var a,t,l,n=choose(i),s=.5*r.getSpellCost(n);setTimeout((a=n,t=s,l=Game.seed,function(){if(Game.seed!=l)return!1;r.castSpell(a,{cost:t,failChanceMax:.5,passthrough:!0})||(r.magic+=o,setTimeout(function(){Game.Popup('<div style="font-size:80%;">'+loc("That's too bad!<br>Magic refunded.")+"</div>",Game.mouseX,Game.mouseY)},1500))}),1e3),Game.Popup('<div style="font-size:80%;">'+loc("Casting %1<br>for %2 magic...",[n.name,Beautify(s)])+"</div>",Game.mouseX,Game.mouseY)}},"resurrect abomination":{name:loc("Resurrect Abomination"),desc:loc("Instantly summon a wrinkler if conditions are fulfilled."),failDesc:loc("Pop one of your wrinklers."),icon:[28,11],costMin:20,costPercent:.1,win:function(){if(!Game.SpawnWrinkler())return Game.Popup('<div style="font-size:80%;">'+loc("Unable to spawn a wrinkler!")+"</div>",Game.mouseX,Game.mouseY),-1;Game.Popup('<div style="font-size:80%;">'+loc("Rise, my precious!")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){if(!Game.PopRandomWrinkler())return Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("But no wrinkler was harmed.")+"</div>",Game.mouseX,Game.mouseY),-1;Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("So long, ugly...")+"</div>",Game.mouseX,Game.mouseY)}},"diminish ineptitude":{name:loc("Diminish Ineptitude"),desc:loc("Spells backfire %1 times less for the next %2 minutes.",[10,5]),failDesc:loc("Spells backfire %1 times more for the next %2 minutes.",[5,10]),icon:[29,11],costMin:5,costPercent:.2,win:function(){Game.killBuff("Magic inept"),Game.gainBuff("magic adept",300,10),Game.Popup('<div style="font-size:80%;">'+loc("Ineptitude diminished!")+"</div>",Game.mouseX,Game.mouseY)},fail:function(){Game.killBuff("Magic adept"),Game.gainBuff("magic inept",600,5),Game.Popup('<div style="font-size:80%;">'+loc("Backfire!")+"<br>"+loc("Ineptitude magnified!")+"</div>",Game.mouseX,Game.mouseY)}}},r.spellsById=[];var i=0;for(t in r.spells)r.spells[t].id=i,r.spellsById[i]=r.spells[t],i++;r.computeMagicM=function(){var e=Math.max(r.parent.amount,1),i=Math.max(r.parent.level,1);r.magicM=Math.floor(4+Math.pow(e,.6)+15*Math.log((e+10*(i-1))/15+1)),r.magic=Math.min(r.magicM,r.magic)},r.getFailChance=function(e){var i=.15;return Game.hasBuff("Magic adept")&&(i*=.1),Game.hasBuff("Magic inept")&&(i*=5),i*=1+.1*Game.auraMult("Supreme Intellect"),e.failFunc?e.failFunc(i):i},r.castSpell=function(e,i){var o,a=!1,t=void 0!==(i=i||{}).cost?i.cost:r.getSpellCost(e);if(!(r.magic<t)){var n=r.getFailChance(e);if(void 0!==i.failChanceSet&&(n=i.failChanceSet),void 0!==i.failChanceAdd&&(n+=i.failChanceAdd),void 0!==i.failChanceMult&&(n*=i.failChanceMult),void 0!==i.failChanceMax&&(n=Math.max(n,i.failChanceMax)),Math.seedrandom(Game.seed+"/"+r.spellsCastTotal),o=!e.fail||Math.random()<1-n?e.win():(a=!0,e.fail()),Math.seedrandom(),-1!=o)return e.passthrough||i.passthrough||(r.spellsCast++,r.spellsCastTotal++,9<=r.spellsCastTotal&&Game.Win("Bibbidi-bobbidi-boo"),99<=r.spellsCastTotal&&Game.Win("I'm the wiz"),999<=r.spellsCastTotal&&Game.Win("A wizard is you")),r.magic-=t,r.magic=Math.max(0,r.magic),n=l("grimoireSpell"+e.id).getBounds(),Game.SparkleAt((n.left+n.right)/2,(n.top+n.bottom)/2-24),a?PlaySound("snd/spellFail.mp3",.75):PlaySound("snd/spell.mp3",.75),!0;PlaySound("snd/spellFail.mp3",.75)}return!1},r.getSpellCost=function(e){var i=e.costMin;return e.costPercent&&(i+=r.magicM*e.costPercent),i*=1-.1*Game.auraMult("Supreme Intellect"),Math.floor(i)},r.getSpellCostBreakdown=function(e){var i="";return e.costPercent?i+=loc("%1 magic",Beautify(e.costMin))+" "+loc("+%1% of max magic",Beautify(Math.ceil(100*e.costPercent))):i+=loc("%1 magic",Beautify(e.costMin)),i},r.spellTooltip=function(t){return function(){var e=r.spellsById[t],i=(e.icon=e.icon||[28,12],Beautify(r.getSpellCost(e))),o=i!=(o=r.getSpellCostBreakdown(e))?" <small>("+o+")</small>":"",a=r.getFailChance(e);return'<div style="padding:8px 4px;min-width:350px;" id="tooltipSpell"><div class="icon" style="float:left;margin-left:-8px;margin-top:-8px;background-position:'+48*-e.icon[0]+"px "+48*-e.icon[1]+'px;"></div><div class="name">'+e.name+"</div><div>"+loc("Magic cost:")+' <b style="color:#'+(i<=r.magic?"6f6":"f66")+';">'+i+"</b>"+o+"</div>"+(e.fail?"<div><small>"+loc("Chance to backfire:")+' <b style="color:#f66">'+Math.ceil(100*a)+"%</b></small></div>":"")+'<div class="line"></div><div class="description"><b>'+loc("Effect:")+'</b> <span class="green">'+(e.descFunc?e.descFunc():e.desc)+"</span>"+(e.failDesc?'<div style="height:8px;"></div><b>'+loc("Backfire:")+'</b> <span class="red">'+e.failDesc+"</span>":"")+"</div></div>"}},r.dragonBoostTooltip=function(){return'<div style="width:280px;padding:8px;text-align:center;" id="tooltipDragonBoost"><b>'+loc("Supreme Intellect")+'</b><div class="line"></div>'+loc("Grimoire spells are %1% cheaper but fail %1% more.",10*Game.auraMult("Supreme Intellect"))+"</div>"};var o=(o="")+"<style>#grimoireBG{background:url("+Game.resPath+"img/shadedBorders.png),url("+Game.resPath+"img/BGgrimoire.jpg);background-size:100% 100%,auto;position:absolute;left:0px;right:0px;top:0px;bottom:16px;}#grimoireContent{position:relative;box-sizing:border-box;padding:4px 24px;}#grimoireBar{max-width:95%;margin:4px auto;height:16px;}#grimoireBarFull{transform:scale(1,2);transform-origin:50% 0;height:50%;}#grimoireBarText{transform:scale(1,0.8);width:100%;position:absolute;left:0px;top:0px;text-align:center;color:#fff;text-shadow:-1px 1px #000,0px 0px 4px #000,0px 0px 6px #000;margin-top:2px;}#grimoireSpells{text-align:center;width:100%;padding:8px;box-sizing:border-box;}.grimoireIcon{pointer-events:none;margin:2px 6px 0px 6px;width:48px;height:48px;opacity:0.8;position:relative;}.grimoirePrice{pointer-events:none;}.grimoireSpell{box-shadow:4px 4px 4px #000;cursor:pointer;position:relative;color:#f33;opacity:0.8;text-shadow:0px 0px 4px #000,0px 0px 6px #000;font-weight:bold;font-size:12px;display:inline-block;width:60px;height:74px;background:url("+Game.resPath+'img/spellBG.png);}.grimoireSpell.ready{color:rgba(255,255,255,0.8);opacity:1;}.grimoireSpell.ready:hover{color:#fff;}.grimoireSpell:hover{box-shadow:6px 6px 6px 2px #000;z-index:1000000001;top:-1px;}.grimoireSpell:active{top:1px;}.grimoireSpell.ready .grimoireIcon{opacity:1;}.grimoireSpell:hover{background-position:0px -74px;} .grimoireSpell:active{background-position:0px 74px;}.grimoireSpell:nth-child(4n+1){background-position:-60px 0px;} .grimoireSpell:nth-child(4n+1):hover{background-position:-60px -74px;} .grimoireSpell:nth-child(4n+1):active{background-position:-60px 74px;}.grimoireSpell:nth-child(4n+2){background-position:-120px 0px;} .grimoireSpell:nth-child(4n+2):hover{background-position:-120px -74px;} .grimoireSpell:nth-child(4n+2):active{background-position:-120px 74px;}.grimoireSpell:nth-child(4n+3){background-position:-180px 0px;} .grimoireSpell:nth-child(4n+3):hover{background-position:-180px -74px;} .grimoireSpell:nth-child(4n+3):active{background-position:-180px 74px;}.grimoireSpell:hover .grimoireIcon{top:-1px;}.grimoireSpell.ready:hover .grimoireIcon{animation-name:bounce;animation-iteration-count:infinite;animation-duration:0.8s;}.noFancy .grimoireSpell.ready:hover .grimoireIcon{animation:none;}#grimoireInfo{text-align:center;font-size:11px;margin-top:12px;color:rgba(255,255,255,0.75);text-shadow:-1px 1px 0px #000;}</style><div id="grimoireBG"></div><div id="grimoireContent"><div id="grimoireSpells">';for(t in r.spells){var a=(n=r.spells[t]).icon||[28,12];o+='<div class="grimoireSpell titleFont" id="grimoireSpell'+n.id+'" '+Game.getDynamicTooltip("Game.ObjectsById["+r.parent.id+"].minigame.spellTooltip("+n.id+")","this")+'><div class="usesIcon shadowFilter grimoireIcon" style="background-position:'+48*-a[0]+"px "+48*-a[1]+'px;"></div><div class="grimoirePrice" id="grimoirePrice'+n.id+'">-</div></div>'}var t,a=[29,14],o=(o+="</div>")+'<div id="grimoireBar" class="smallFramed meterContainer" style="width:1px;"><div '+Game.getDynamicTooltip("Game.ObjectsById["+r.parent.id+"].minigame.refillTooltip","this")+' id="grimoireLumpRefill" class="usesIcon shadowFilter lumpRefill" style="left:-40px;top:-17px;background-position:'+48*-a[0]+"px "+48*-a[1]+'px;"></div><div id="grimoireBarFull" class="meter filling" style="width:1px;"></div><div id="grimoireBarText" class="titleFont"></div><div '+Game.getTooltip('<div style="padding:8px;width:300px;font-size:11px;text-align:center;">'+loc('This is your magic meter. Each spell costs magic to use.<div class="line"></div>Your maximum amount of magic varies depending on your amount of <b>Wizard towers</b>, and their level.<div class="line"></div>Magic refills over time. The lower your magic meter, the slower it refills.')+"</div>")+' style="position:absolute;left:0px;top:0px;right:0px;bottom:0px;"></div></div>';for(t in e.innerHTML=o+='<div id="grimoireInfo"></div></div>',r.magicBarL=l("grimoireBar"),r.magicBarFullL=l("grimoireBarFull"),r.magicBarTextL=l("grimoireBarText"),r.lumpRefill=l("grimoireLumpRefill"),r.infoL=l("grimoireInfo"),r.spells){var n=r.spells[t];AddEvent(l("grimoireSpell"+n.id),"click",function(e){return function(){PlaySound("snd/tick.mp3"),r.castSpell(e)}}(n))}r.refillTooltip=function(){return'<div style="padding:8px;width:300px;font-size:11px;text-align:center;" id="tooltipRefill">'+loc("Click to refill <b>%1 units</b> of your magic meter for %2.",[100,'<span class="price lump">'+loc("%1 sugar lump",LBeautify(1))+"</span>"])+(Game.canRefillLump()?"<br><small>("+loc("can be done once every %1",Game.sayTime(Game.getLumpRefillMax(),-1))+")</small>":'<br><small class="red">('+loc("usable again in %1",Game.sayTime(Game.getLumpRefillRemaining()+Game.fps,-1))+")</small>")+"</div>"},AddEvent(r.lumpRefill,"click",function(){r.magic<r.magicM&&Game.refillLump(1,function(){r.magic+=100,r.magic=Math.min(r.magic,r.magicM),PlaySound("snd/pop"+Math.floor(3*Math.random()+1)+".mp3",.75)})}),r.computeMagicM(),r.magic=r.magicM,r.spellsCast=0,r.spellsCastTotal=0},r.save=function(){return parseFloat(r.magic)+" "+parseInt(Math.floor(r.spellsCast))+" "+parseInt(Math.floor(r.spellsCastTotal))+" "+parseInt(r.parent.onMinigame?"1":"0")},r.load=function(e){if(!e)return!1;var i=0,e=e.split(" ");r.computeMagicM(),r.magic=parseFloat(e[i++]||r.magicM),r.spellsCast=parseInt(e[+i]||0),r.spellsCastTotal=parseInt(e[2]||0),parseInt(e[3]||0)&&1!=Game.ascensionMode&&r.parent.switchMinigame(1)},r.reset=function(){r.computeMagicM(),r.magic=r.magicM,r.spellsCast=0},r.logic=function(){if(Game.T%5==0&&r.computeMagicM(),r.magicPS=.002*Math.max(.002,Math.pow(r.magic/Math.max(r.magicM,100),.5)),r.magic+=r.magicPS,r.magic=Math.min(r.magic,r.magicM),Game.T%5==0)for(var e in r.spells){var e=r.spells[e],i=r.getSpellCost(e);l("grimoirePrice"+e.id).innerHTML=Beautify(i),r.magic<i?l("grimoireSpell"+e.id).className="grimoireSpell titleFont":l("grimoireSpell"+e.id).className="grimoireSpell titleFont ready"}},r.draw=function(){Game.drawT%5==0&&(r.magicBarTextL.innerHTML=Math.min(Math.floor(r.magicM),Beautify(r.magic))+"/"+Beautify(Math.floor(r.magicM))+(r.magic<r.magicM?" ("+loc("+%1/s",Beautify((r.magicPS||0)*Game.fps,2))+")":""),r.magicBarFullL.style.width=r.magic/r.magicM*100+"%",r.magicBarL.style.width=3*r.magicM+"px",r.infoL.innerHTML=loc("Spells cast: %1 (total: %2)",[Beautify(r.spellsCast),Beautify(r.spellsCastTotal)])),r.magicBarFullL.style.backgroundPosition=.5*-Game.T+"px"},r.init(l("rowSpecial"+r.parent.id))};var M=0;