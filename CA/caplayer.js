"use strict";function _typeof3(e){return(_typeof3="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _typeof2(e){return(_typeof2="function"==typeof Symbol&&"symbol"==_typeof3(Symbol.iterator)?function(e){return _typeof3(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":_typeof3(e)})(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==_typeof2(Symbol.iterator)?function(e){return _typeof2(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":_typeof2(e)})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,i,l,o=[],c=!0,s=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(o.push(r.value),o.length!==t);c=!0);}catch(e){s=!0,a=e}finally{try{if(!c&&null!=n.return&&(l=n.return(),Object(l)!==l))return}finally{if(s)throw a}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var n,r,a,i,l="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(l)return a=!(r=!0),{s:function(){l=l.call(e)},n:function(){var e=l.next();return r=e.done,e},e:function(e){a=!0,n=e},f:function(){try{r||null==l.return||l.return()}finally{if(a)throw n}}};if(Array.isArray(e)||(l=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return l&&(e=l),i=0,{s:t=function(){},n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){return"symbol"==_typeof(e=_toPrimitive(e,"string"))?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);if("object"!=_typeof(n=n.call(e,t||"default")))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var rule,socket,TreeNode=_createClass(function e(t){_classCallCheck(this,e),this.distance=t,this.value=null,this.key=null,this.child=[null,null,null,null],this.result=null,this.depth=null,this.nextHashedNode=null,this.population=0}),ListNode=_createClass(function e(t){_classCallCheck(this,e),this.value=0,this.tree=null,this.child=null,this.parent=t}),EventNode=_createClass(function e(t){if(_classCallCheck(this,e),null!==(this.parent=t)&&(t.child=this),this.child=null,this.action="unknown",arguments.length<=2)this.rule=rulestring,0===GRID.type?this.head=GRID.head:(this.finiteArea={left:GRID.finiteArea.left,top:GRID.finiteArea.top,margin:GRID.finiteArea.margin},this.finiteArray=patternToRLE(GRID.finiteArray)),this.type=GRID.type,this.backgroundState=GRID.backgroundState,this.generation=genCount,this.resetEvent=resetEvent,this.time=Date.now(),arguments[1]&&(this.action=arguments[1]);else{for(var n=2;n<arguments.length;n+=2){var r=arguments[n],a=arguments[n+1];-1!==r.indexOf("draw")&&(this.draw=a),-1!==r.indexOf("paste")&&(this.paste=a),this.action=r,console.log(r)}this.time=arguments[1]}}),Pointer=_createClass(function e(t,n){_classCallCheck(this,e),this.dragX=t,this.dragY=n,this.X=t,this.Y=n},[{key:"deltaX",get:function(){return this.dragX-this.X}},{key:"deltaY",get:function(){return this.dragY-this.Y}}]),accumulateChanges=new ListNode(null),activeClipboard=1,canvas=document.getElementById("ourCanvas"),captureScroll=!1,cellWidth=20,changeCount=0,clipboard=Array(3).fill().map(function(){return{pattern:[],shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0},previewBitmap:null}}),ctx=canvas.getContext("2d"),darkMode=1,detailedCanvas=!0,depthTotal=0,depthCount=0,edgeBeingDragged=0,drawMode=-1,drawnState=-1,editMode=0,emptyNodes=[],frameMultiplier=1,genCount=0,GRID={type:0,head:null,finiteArray:[],finiteArea:{margin:0,top:0,right:0,bottom:0,left:0,newTop:0,newRight:0,newBottom:0,newLeft:0},backgroundState:0},gridPopulation=0,hashTable=new Array(999953),hashTableDepths=[],isKeyBeingPressed=!1,isPlaying=0,key=[],markers=Array(6).fill().map(function(){return{activeState:0,top:0,right:0,bottom:0,left:0,pattern:[],shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0}}}),maxDepth=2e4,pointers=[],numberOfNodes=0,pasteArea={isActive:!1,top:0,left:0,pointerRelativeX:0,pointerRelativeY:0},resetEvent=null,rulestring="B3/S23",ruleMetadata={size:0,family:"INT",color:[]},selectArea={isActive:!1,top:0,right:0,bottom:0,left:0},selectedMarker=-1,stepSize=1,timeOfLastUpdate=0,timeOfLastGeneration=0,view={x:-15,y:-10,z:1,touchX:0,touchY:0,touchZ:1},wasReset=!1,windowHeight=0,windowWidth=0,canvasWidth=0,canvasHeight=0;try{socket=io()}catch(e){socket=null}var clientId,clientList={},currentEvent=(parseRulestring("B3/S23"),GRID.head=writeNode(getEmptyNode(8)),new EventNode(null,"start"));function main(){if((windowWidth!==(window.innerWidth||document.documentElement.clientWidth)||windowHeight<(window.innerHeight||document.documentElement.clientHeight)||windowHeight>(window.innerHeight||document.documentElement.clientHeight)+40)&&scaleCanvas(),frameMultiplier=0===timeOfLastUpdate?1:.1*(9*frameMultiplier+.04*(Date.now()-timeOfLastUpdate)),timeOfLastUpdate=Date.now(),keyInput(),0<pointers.length&&update(),isPlaying<0||0<isPlaying&&Date.now()-timeOfLastGeneration>1e3-10*parseInt(document.getElementById("speed").value)){timeOfLastGeneration=Date.now(),null===resetEvent&&(resetEvent=new EventNode(currentEvent.parent,"reset point"),"paste"in currentEvent&&(resetEvent.paste=currentEvent.paste),"draw"in currentEvent&&(resetEvent.draw=currentEvent.draw),currentEvent=resetEvent,0!==GRID.type)&&"string"==typeof resetEvent.finiteArray&&(resetEvent.finiteArray=readRLE(resetEvent.finiteArray));for(var e=0;e<stepSize;e++)gen(GRID),currentEvent=new EventNode(currentEvent,"gen"),isPlaying<0&&isPlaying++;0===GRID.type?document.getElementById("population").innerHTML="Population "+(0===GRID.backgroundState?GRID.head.population:GRID.head.distance*GRID.head.distance-GRID.head.population):document.getElementById("population").innerHTML="Population "+gridPopulation,document.getElementById("gens").innerHTML="Generation "+genCount,wasReset=!1;for(var t=0;t<document.getElementById("searchOptions").children.length-1;t++)searchAction(document.getElementById("searchOptions").children[t])}render(),0===isPlaying&&!isKeyBeingPressed||requestAnimationFrame(main)}function calculateKey(e){if(1===e.distance)e.key=e.value,e.population=1===e.value?1:0;else{e.key=rule.length;for(var t=[7,1217,7919,104729],n=e.population=0;n<4;n++)null!==e.child[n]&&(null===e.child[n].key&&calculateKey(e.child[n]),e.key=e.key^e.child[n].key*t[n],e.population+=e.child[n].population)}}function mod(e,t){return(e%t+t)%t}function distance(e,t){return Math.sqrt(e*e+t*t)}function iteratePattern(e,t,n,r,a){for(var i=[1,-1,-1,1,0,-1,1,0,0],l=[-1,-1,1,1,-1,0,0,1,0],o=new Array(n-a),c=a;c<n;c++){o[c-a]=new Array(r-t);for(var s=t;s<r;s++){for(var d=rule,h=0;h<9;h++)d=d[e[mod(c+i[h],e.length)][mod(s+l[h],e[0].length)]];o[c-a][s-t]=d}}return o}function getResult(e){var t=new TreeNode(e.distance>>>1);if(e.distance<4)console.log("Error: Cannot find result of node smaller than 4");else if(4===e.distance)t=writePatternToGrid(-1,-1,iteratePattern(readPattern(-2,2,2,-2,{head:e}),1,3,3,1),getEmptyNode(2));else if(8<=e.distance){for(var n=0;n<4;n++)t.child[n]=new TreeNode(e.distance>>>2),t.child[n].child[n]=e.child[n].result.child[3-n];var r=new TreeNode(e.distance>>>1);r.child[0]=e.child[0].child[1],r.child[1]=e.child[1].child[0],r.child[2]=e.child[0].child[3],r.child[3]=e.child[1].child[2],r.value=getValue(r),r=writeNode(r),t.child[0].child[1]=r.result.child[2],t.child[1].child[0]=r.result.child[3],(r=new TreeNode(e.distance>>>1)).child[0]=e.child[1].child[2],r.child[1]=e.child[1].child[3],r.child[2]=e.child[3].child[0],r.child[3]=e.child[3].child[1],r.value=getValue(r),r=writeNode(r),t.child[1].child[3]=r.result.child[0],t.child[3].child[1]=r.result.child[2],(r=new TreeNode(e.distance>>>1)).child[0]=e.child[2].child[1],r.child[1]=e.child[3].child[0],r.child[2]=e.child[2].child[3],r.child[3]=e.child[3].child[2],r.value=getValue(r),r=writeNode(r),t.child[3].child[2]=r.result.child[1],t.child[2].child[3]=r.result.child[0],(r=new TreeNode(e.distance>>>1)).child[0]=e.child[0].child[2],r.child[1]=e.child[0].child[3],r.child[2]=e.child[2].child[0],r.child[3]=e.child[2].child[1],r.value=getValue(r),r=writeNode(r),t.child[2].child[0]=r.result.child[3],t.child[0].child[2]=r.result.child[1],(r=new TreeNode(e.distance>>>1)).child[0]=e.child[0].child[3],r.child[1]=e.child[1].child[2],r.child[2]=e.child[2].child[1],r.child[3]=e.child[3].child[0],r.value=getValue(r),r=writeNode(r),t.child[0].child[3]=r.result.child[0],t.child[1].child[2]=r.result.child[1],t.child[2].child[1]=r.result.child[2],t.child[3].child[0]=r.result.child[3];for(var a=0;a<4;a++)t.child[a].value=getValue(t.child[a]),t.child[a]=writeNode(t.child[a]);t.value=getValue(t)}return writeNode(t)}function writeNode(e){calculateKey(e);for(var t=hashTable[e.key%hashTable.length],n=null,r=0,a=0;;a++){if(maxDepth<a){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(!t){e.depth=a,null===e.result&4<=e.distance&&(e.result=getResult(e)),n&&(n.nextHashedNode=e),hashTable[e.key%hashTable.length]||(hashTable[e.key%hashTable.length]=e),numberOfNodes++;break}if(isEqual(t,e)){e=t,n&&(n.nextHashedNode=e),hashTable[e.key%hashTable.length]||(hashTable[e.key%hashTable.length]=e);break}r++,t=(n=t).nextHashedNode}return depthTotal+=r,depthCount++,hashTableDepths[r]||(hashTableDepths[r]=0),hashTableDepths[r]++,e}function isEqual(e,t){if(e===t)return!0;if(e&&t)if(1===e.distance&&1===t.distance){if(e.value===t.value)return!0}else if(e.distance===t.distance){for(var n=0;n<4;n++)if(!1===isEqual(e.child[n],t.child[n]))return!1;return!0}return!1}function getValue(e){return 1===e.distance?e.value:null!==e.child[0].value&&e.child[0].value===e.child[1].value&&e.child[1].value===e.child[2].value&&e.child[2].value===e.child[3].value?e.child[0].value:null}function doubleSize(e){emptyNodes=emptyNodes.map(function(){return null});for(var t=new TreeNode(e.distance<<1),n=0;n<4;n++){t.child[n]=new TreeNode(e.distance),t.child[n].child[3-n]=e.child[n],emptyNodes[GRID.backgroundState]=getEmptyNode(e.distance>>>1);for(var r=0;r<4;r++)r!==3-n&&(t.child[n].child[r]=emptyNodes[GRID.backgroundState]);t.child[n].value=getValue(t.child[n]),t.child[n]=writeNode(t.child[n])}return t.value=getValue(t),writeNode(t)}function importSettings(){for(var e=window.location.search.split("&"),t=0;t<e.length;t++)e[t]=e[t].split("=");console.log(e);var n,r=_createForOfIteratorHelper(e);try{for(r.s();!(n=r.n()).done;){var a=_slicedToArray(n.value,2),i=a[0],l=a[1],o=void 0,c=void 0;switch(i){case"gen":genCount=parseInt(l),document.getElementById("gens").innerHTML="Generation "+genCount;break;case"background":GRID.backgroundState=parseInt(l);break;case"step":stepSize=parseInt(l),document.getElementById("step").value=stepSize;break;case"resetStop":"false"===l&&(document.getElementById("resetStop").checked=!1);break;case"ratio":document.getElementById("density").value=parseInt(l),document.getElementById("percent").innerHTML="".concat(l,"%");break;case"slot":activeClipboard=parseInt(l);for(var s=0;s<document.getElementById("copyMenu").children.length;s++)document.getElementById("copyMenu").children[s].innerHTML.includes(l.toString())&&replaceDropdownElement(document.getElementById("copyMenu").children[s]);break;case"slots":for(var c=l.split("."),d=0;4*d<c.length;d++){if(clipboard[d+1].pattern=baseNToPattern(parseInt(c[4*d]),parseInt(c[4*d+1]),LZ77ToBaseN(c[4*d+2])),clipboard[d+1].pattern&&clipboard[d+1].pattern[0]&&(clipboard[d+1].previewBitmap=patternToBitmap(clipboard[d+1].pattern)),""!==c[4*d+3]){var h=c[4*d+3].split(",");clipboard[d+1].shipInfo={dx:parseInt(h[2]),dy:parseInt(h[3]),shipOffset:{x:parseInt(h[4]),y:parseInt(h[5])},phases:Array(h.length-6),period:h.length-6};for(var p=6;p<h.length;p++)clipboard[d+1].shipInfo.phases[p-6]=baseNToPattern(parseInt(h[0]),parseInt(h[1]),LZ77ToBaseN(h[p]))}0<d&&(document.getElementById("copyMenu").innerHTML+='<button onclick="changeCopySlot(this);" onmouseenter="showPreview(this);">'.concat(d+2,'<canvas class="patternPreview"></canvas></button>'),clipboard.push({pattern:[],shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0},previewBitmap:null}))}break;case"selA":selectArea.isActive=!0,setActionMenu(),o=l.split(".").map(function(e){return parseInt(e)}),selectArea.top=o[0],selectArea.right=o[1],selectArea.bottom=o[2],selectArea.left=o[3];break;case"pasteA":pasteArea.isActive=!0,setActionMenu(),o=l.split(".").map(function(e){return parseInt(e)}),pasteArea.top=o[0],pasteArea.left=o[1];break;case"pat":for(var u,o=[0,0,0,0],f=0;f<4;f++)o[f]=parseInt(l.split(".")[f]);5===l.split(".").length?(u=baseNToPattern(o[1]-o[3],o[2]-o[0],LZ77ToBaseN(l.split(".")[4])),GRID.head=widenTree({top:o[0],right:o[1],bottom:o[2],left:o[3]}),GRID.head=writePatternToGrid(o[3],o[0],u,GRID.head),document.getElementById("population").innerHTML="Population "+(0===GRID.backgroundState?GRID.head.population:GRID.head.distance*GRID.head.distance-GRID.head.population)):(GRID.type=parseInt(l.split(".")[4]),GRID.finiteArea={margin:1===GRID.type?1:0,top:o[0],right:o[1],bottom:o[2],left:o[3],newTop:o[0],newRight:o[1],newBottom:o[2],newLeft:o[3]},GRID.finiteArray=baseNToPattern(o[1]-o[3]+2*GRID.finiteArea.margin,o[2]-o[0]+2*GRID.finiteArea.margin,LZ77ToBaseN(l.split(".")[5])),document.getElementById("population").innerHTML="Population "+gridPopulation),fitView();break;case"rule":document.getElementById("rule").value=decodeURIComponent(l),setRule(decodeURIComponent(l));break;case"marker":c=l.split(".").map(function(e){return isNaN(e)||""===e?e:parseInt(e)});for(var g=0;g<c.length;g+=7)if(markers[c[g]]={activeState:1,top:c[g+1],right:c[g+2],bottom:c[g+3],left:c[g+4],shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0},pattern:[]},""!==c[g+5]&&(markers[c[g]].pattern=baseNToPattern(c[g+2]-c[g+4],c[g+3]-c[g+1],LZ77ToBaseN(c[g+5]))),c[g+6]&&""!==c[g+6]){var v=c[g+6].split(",");markers[c[g]].shipInfo={dx:parseInt(v[2]),dy:parseInt(v[3]),shipOffset:{x:parseInt(v[4]),y:parseInt(v[5])},phases:Array(v.length-6),period:v.length-6};for(var m=6;m<v.length;m++)markers[c[g]].shipInfo.phases[m-6]=baseNToPattern(parseInt(v[0]),parseInt(v[1]),LZ77ToBaseN(v[m]))}break;case"rleMargin":document.getElementById("rleMargin").value=l;break;case"userReset":document.getElementById("userReset").checked=!0;break;case"search":c=l.split(".");for(var y=0;y<c.length;y++){var A=c[y].split(","),I=document.getElementById("searchOptions").lastElementChild;changeAction(findElementContaining(I.children[1].children[1],decodeURIComponent(A[0])));for(var w=1;w<A.length;w++)if(I.children[w+1]&&""!==A[w])if("INPUT"===I.children[w+1].tagName){if(I.children[w+1].setAttribute("value",decodeURIComponent(A[w])),"Generate Salvo"===decodeURIComponent(A[0]))switch(w){case 1:I.info.repeatTime=parseInt(A[w]);break;case 3:for(var b=0;b<parseInt(A[w]);b++)incrementSearch(I.info)}}else I.children[w+1].className.includes("condition")?changeCondition(findElementContaining(I.children[w+1],decodeURIComponent(A[w]))):I.children[w+1].className.includes("conjunction")?"Not When"===decodeURIComponent(A[w])&&replaceDropdownElement(findElementContaining(I.children[w+1],decodeURIComponent(A[w]))):I.children[w+1].className.includes("dropdown")&&replaceDropdownElement(findElementContaining(I.children[w+1],decodeURIComponent(A[w])))}}}}catch(e){r.e(e)}finally{r.f()}currentEvent=new EventNode(null,"import URL"),render()}function findElementContaining(e,t){if(e.innerHTML===t)return e;for(var n=0;n<e.children.length;n++){var r=findElementContaining(e.children[n],t);if(null!==r)return r}return null}function exportSetting(){var e,t,n,r="".concat(window.location.protocol,"//").concat(window.location.host,"\n\t\t").concat(window.location.pathname,"?v=0.4.4");if(null!==resetEvent&&setEvent(resetEvent),-1!==drawMode&&(r+="&draw="+drawMode),0!==genCount&&(r+="&gen="+genCount),0!==GRID.backgroundState&&(r+="&background="+GRID.backgroundState),1!==stepSize&&(r+="&step="+stepSize),1!==activeClipboard&&(r+="&slot="+activeClipboard),3<clipboard.length||clipboard[1]){r+="&slots=";for(var a=1;a<clipboard.length-1;a++)if(1<a&&(r+="."),clipboard[a]&&0<clipboard[a].pattern.length){if(r+="".concat(clipboard[a].pattern.length,".").concat(clipboard[a].pattern[0].length,".").concat(baseNToLZ77(patternToBaseN(clipboard[a].pattern)),"."),null!==clipboard[a].shipInfo.dx){r+="".concat(clipboard[a].shipInfo.phases[0].length,",").concat(clipboard[a].shipInfo.phases[0][0].length,",").concat(clipboard[a].shipInfo.dx,",").concat(clipboard[a].shipInfo.dy,",").concat(clipboard[a].shipInfo.shipOffset.x,",").concat(clipboard[a].shipInfo.shipOffset.y);for(var i=0;i<clipboard[a].shipInfo.phases.length;i++)r+=","+baseNToLZ77(patternToBaseN(clipboard[a].shipInfo.phases[i]))}}else r+="0.0.."}selectArea.isActive&&(r+="&selA=".concat(selectArea.top,".").concat(selectArea.right,".").concat(selectArea.bottom,".").concat(selectArea.left)),pasteArea.isActive&&(r+="&pasteA=".concat(pasteArea.top,".").concat(pasteArea.left)),!1===isElementCheckedById("resetStop")&&(r+="&resetStop=false"),"B3/S23"!==rulestring&&(r+="&rule="+encodeURIComponent(rulestring)),0===GRID.type?0!==GRID.head.value&&(n=GRID.head,null!==resetEvent&&(GRID.head=resetEvent.head),t=[(null!=(t=getTopBorder(GRID.head))?t:0)/2-.5,(null!=(t=getRightBorder(GRID.head))?t:0)/2+.5,(null!=(t=getBottomBorder(GRID.head))?t:0)/2+.5,(null!=(t=getLeftBorder(GRID.head))?t:0)/2-.5],e=baseNToLZ77(patternToBaseN(readPattern.apply(void 0,_toConsumableArray(t).concat([GRID])))),GRID.head=n,r+="&pat=".concat(t.join("."),".").concat(e)):(t=[GRID.finiteArea.top,GRID.finiteArea.right,GRID.finiteArea.bottom,GRID.finiteArea.left],e=baseNToLZ77(patternToBaseN(GRID.finiteArray)),r+="&pat=".concat(t.join("."),".").concat(GRID.type,".").concat(e)),"50"!==document.getElementById("density").value&&(r+="&ratio="+document.getElementById("density").value);for(var l="",o=0;o<markers.length;o++)if(markers[o].activeState&&(""!==l&&(l+="."),l+="".concat(o,".").concat(markers[o].top,".").concat(markers[o].right,".").concat(markers[o].bottom,".").concat(markers[o].left,".").concat(baseNToLZ77(patternToBaseN(markers[o].pattern)),".")),null!==markers[o].shipInfo.dx){l+="".concat(markers[o].shipInfo.phases[0].length,",").concat(markers[o].shipInfo.phases[0][0].length,",").concat(markers[o].shipInfo.dx,",").concat(markers[o].shipInfo.dy,",").concat(markers[o].shipInfo.shipOffset.x,",").concat(markers[o].shipInfo.shipOffset.y);for(var c=0;c<markers[o].shipInfo.phases.length;c++)l+=","+baseNToLZ77(patternToBaseN(markers[o].shipInfo.phases[c]))}""!==l&&(r+="&marker="+l),"16"!==document.getElementById("rleMargin").value&&(r+="&rleMargin="+document.getElementById("rleMargin").value),!0===isElementCheckedById("userReset")&&(r+="&userReset=true");var s=document.getElementById("searchOptions").children;if(1<s.length){r+="&search=";for(var d=0;d<s.length-1;d++)for(var h=1;h<s[d].children.length-1;h++)1===h?0!==d&&(r+="."):r+=",",s[d].children[h].className.includes("dropdown")?r+=encodeURIComponent(s[d].children[h].children[0].innerHTML):"INPUT"===s[d].children[h].tagName&&(r+=encodeURIComponent(s[d].children[h].value))}document.getElementById("settingsExport").innerHTML=r,document.getElementById("settingsExport").href=r,null!==resetEvent&&setEvent(currentEvent)}function reloadPointers(e){for(var t=0;t<e.touches.length;t++)pointers.length<=t&&pointers.push(new Pointer(e.touches[t].clientX-canvas.getBoundingClientRect().left,e.touches[t].clientY-canvas.getBoundingClientRect().top)),pointers[t].X=e.touches[t].clientX-canvas.getBoundingClientRect().left,pointers[t].Y=e.touches[t].clientY-canvas.getBoundingClientRect().top;!1===isKeyBeingPressed&&0===isPlaying&&(0<pointers.length&&update(),render())}function resetPointers(e){edgeBeingDragged=0,e.cancelable&&e.preventDefault(),inputReset(),pointers=[],reloadPointers(e)}function updateDropdownMenu(){for(var e=document.getElementsByClassName("dropdown"),t=0;t<e.length;t++){var n=parseInt(e[t].children[1].getBoundingClientRect().height),r=e[t].children[0].getBoundingClientRect();r.top<n||r.bottom+n<window.innerHeight?e[t].children[1].style.bottom="unset":e[t].children[1].style.bottom=e[t].offsetHeight+"px"}}function inputReset(){if(captureScroll=!0,view.touchX=view.x,view.touchY=view.y,view.touchZ=view.z,-1!==drawnState){drawnState=-1;for(var e=accumulateChanges,t=new Array(changeCount),n=0;n<changeCount&&null!==e.parent;n++)e=e.parent,t[n]=e.value;socket&&null===resetEvent&&socket.emit("draw",Date.now(),t),currentEvent=new EventNode(currentEvent,Date.now(),"draw",t),changeCount=0,accumulateChanges=new ListNode(null)}if(GRID.finiteArea.newTop!==GRID.finiteArea.top||GRID.finiteArea.newRight!==GRID.finiteArea.right||GRID.finiteArea.newBottom!==GRID.finiteArea.bottom||GRID.finiteArea.newLeft!==GRID.finiteArea.left){for(var r=new Array(GRID.finiteArea.newRight-GRID.finiteArea.newLeft+(1===GRID.type?2:0)),a=0;a<r.length;a++){r[a]=new Array(GRID.finiteArea.newBottom-GRID.finiteArea.newTop+(1===GRID.type?2:0));for(var i=0;i<r[0].length;i++)a>=GRID.finiteArea.left-GRID.finiteArea.newLeft+GRID.finiteArea.margin&&a<GRID.finiteArea.left-GRID.finiteArea.newLeft+GRID.finiteArray.length-GRID.finiteArea.margin&&i>=GRID.finiteArea.top-GRID.finiteArea.newTop+GRID.finiteArea.margin&&i<GRID.finiteArea.top-GRID.finiteArea.newTop+GRID.finiteArray[0].length-GRID.finiteArea.margin?r[a][i]=GRID.finiteArray[a+GRID.finiteArea.newLeft-GRID.finiteArea.left][i+GRID.finiteArea.newTop-GRID.finiteArea.top]:r[a][i]=GRID.backgroundState}GRID.finiteArray=r,GRID.finiteArea.top=GRID.finiteArea.newTop,GRID.finiteArea.right=GRID.finiteArea.newRight,GRID.finiteArea.bottom=GRID.finiteArea.newBottom,GRID.finiteArea.left=GRID.finiteArea.newLeft}selectedMarker=-1,selectArea.left!==selectArea.right&&selectArea.top!==selectArea.bottom||(selectArea.isActive=!1,setActionMenu())}function keyInput(){key[221]&&zoom(1+.05*frameMultiplier),key[219]&&zoom(1/(1+.05*frameMultiplier)),key[16]||(key[65]&&(view.x-=.5/view.z*frameMultiplier),key[87]&&(view.y-=.5/view.z*frameMultiplier),key[68]&&(view.x+=.5/view.z*frameMultiplier),key[83]&&(view.y+=.5/view.z*frameMultiplier),(key[65]||key[87]||key[68]||key[83])&&socket&&null===resetEvent&&socket.emit("pan",{id:clientId,xPosition:view.x,yPosition:view.y}))}function getColor(e){var t;return document.getElementById("antiStrobing").checked&&(e=(e-GRID.backgroundState+rule.length)%rule.length),ruleMetadata.color[e]||(darkMode?0===e?"#222":1===e?"#f1f1f1":(t=240/rule.length*(rule.length-e),"rgb(".concat(t,",").concat(t,",").concat(t,")")):0===e?"#f1f1f1":1===e?"#000":(t=240/rule.length*(e-1),"rgb(".concat(t,",").concat(t,",").concat(t,")")))}function draw(){pasteArea.isActive&&resetClipboard(),captureScroll=!0,(editMode=0)===isPlaying&&render()}function move(){editMode=1,captureScroll=!0,console.log("set move mode")}function select(){!0===selectArea.isActive&&2===editMode&&(selectArea.isActive=!1),resetClipboard(),setActionMenu(),editMode=2,captureScroll=!0,0===isPlaying&&render()}function setActionMenu(){var e,t=_createForOfIteratorHelper(document.getElementsByClassName("displayIf"));try{for(t.s();!(e=t.n()).done;){var n=e.value;if(n.style.display="none",n.classList.contains("select")&&!0===selectArea.isActive&&(n.style.display="block"),n.classList.contains("noSelect")&&!1===selectArea.isActive&&(n.style.display="block"),n.classList.contains("noArea")&&!1===selectArea.isActive&&!1===pasteArea.isActive&&(n.style.display="block"),n.classList.contains("paste")&&!0===pasteArea.isActive&&(n.style.display="block"),n.classList.contains("marker"))for(var r=0;r<markers.length;r++)if(1<markers[r].activeState){n.style.display="block";break}}}catch(e){t.e(e)}finally{t.f()}}function setDrawMenu(){document.getElementById("drawMenu").children[1].innerHTML='<button onclick="changeDrawMode(this);" style="display: none;">Cycle</button>';for(var e=0;e<rule.length;e++)document.getElementById("drawMenu").children[1].innerHTML+='<button onclick="changeDrawMode(this);">'.concat(e,"</button>"),0!==e&&(document.getElementById("drawMenu").children[1].children[e+1].style.backgroundColor=getColor(e)),e>.8*rule.length||0===e?document.getElementById("drawMenu").children[1].children[e+1].style.color=darkMode?"#bbb":"#000":document.getElementById("drawMenu").children[1].children[e+1].style.color=darkMode?"#000":"#bbb"}function identify(){var e=Date.now(),t=(!1===selectArea.isActive&&selectAll(),findShip(readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left),selectArea));0===t.period?alert("couldn't recognize periodic pattern"):(document.getElementById("identifyOutput").innerHTML="\n\t\t<span>\n\t\t\tselect area width: ".concat(selectArea.right-selectArea.left,"\n\n\t\t\tselect area height: ").concat(selectArea.bottom-selectArea.top,"\n\n\t\t\tperiod: ").concat(t.period,"\n\n\t\t\tx displacement: ").concat(t.dx,"\n\n\t\t\ty displacement: ").concat(t.dy,"\n\t\t\ttime elapsed: ").concat(Math.ceil(Date.now()-e),'\n\t\t</span>\n\t\t<canvas id="identifiedShip" style="float: none;margin: none;"></canvas>'),e=document.getElementById("identifiedShip").getContext("2d"),t=patternToBitmap(t.phases[0]),document.getElementById("identifiedShip").width=t.width,document.getElementById("identifiedShip").height=t.height,e.drawImage(t,0,0))}function getTopPatternMargin(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e.length,r=0;r<e[0].length;r++)for(var a=t;a<n;a++)if(0!==e[a][r])return r;return-1}function getRightPatternMargin(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e[0].length,r=e.length-1;0<=r;r--)for(var a=t;a<n;a++)if(0!==e[r][a])return r+1;return-1}function getBottomPatternMargin(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e.length,r=e[0].length-1;0<=r;r--)for(var a=t;a<n;a++)if(0!==e[a][r])return r+1;return-1}function getLeftPatternMargin(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e[0].length,r=0;r<e.length;r++)for(var a=t;a<n;a++)if(0!==e[r][a])return r;return-1}function getSpaceshipEnvelope(e,t,n){var r=t.head,a=new EventNode(null),i=findPattern(readPattern(n.top,n.right,n.bottom,n.left,t),e);if(-1===i.x)return console.trace(),console.log("can't find ship"),{dx:null,dy:null,period:0};for(var l=[i.y+n.top,i.x+n.left+e.length,i.y+n.top+e[0].length,i.x+n.left],o=new Array(4),c=[].concat(l),s=1;s<300;s++){gen(t),o[0]=l[0]-Math.floor(+s),o[1]=l[1]+Math.ceil(+s),o[2]=l[2]+Math.ceil(+s),o[3]=l[3]-Math.floor(+s);var d=readPattern.apply(void 0,o.concat([t])),h=findPattern(readPattern.apply(void 0,o.concat([t])),e);if(c[0]=Math.min(o[0]+getTopPatternMargin(d),c[0]),c[1]=Math.max(o[3]+getRightPatternMargin(d),c[1]),c[2]=Math.max(o[0]+getBottomPatternMargin(d),c[2]),c[3]=Math.min(o[3]+getLeftPatternMargin(d),c[3]),-1!==h.x){t.head=r;for(var p=new Array(s),u=0;u<s;u++)p[u]=readPattern.apply(void 0,_toConsumableArray(c).concat([t])),gen(t);return setEvent(a),{dx:h.x+o[3]-(i.x+n.left),dy:h.y+o[0]-(i.y+n.top),shipOffset:{x:c[3]-n.left,y:c[0]-n.top},period:s,phases:p}}}return setEvent(a),{dx:null,dy:null,shipOffset:{x:null,y:null},period:0,phases:[]}}function findShip(e,t){if(-1!==findPattern(readPattern(t.top,t.right,t.bottom,t.left),e).x)return getSpaceshipEnvelope(e,GRID,t);for(var n=8;n<2*e.length;)if(maxDepth<(n*=2))return console.log("pattern too large"),{dx:null,dy:null,shipOffset:{x:null,y:null},period:0,phases:[]};return(t={head:getEmptyNode(n),backgroundState:0,type:0}).head=writePatternToGrid(-n/4,-n/4,e,t.head),getSpaceshipEnvelope(e,t,{top:-n/4,right:n/4,bottom:n/4,left:-n/4})}function patternToBitmap(e){var t=200/e.length,n=Math.ceil(t*e[0].length),r=(n=new OffscreenCanvas(200,n)).getContext("2d");r.scale(1,1),r.strokeStyle=darkMode?"#999":"#000000";for(var a=0;a<e.length;a++)for(var i=0;i<e[a].length;i++)r.fillStyle=getColor(e[a][i]),0!==e[a][i]&&r.fillRect(a*t,i*t,t,t);r.lineWidth=1,r.beginPath();for(var l=0;l<=e.length;l++)r.moveTo(l*t,0),r.lineTo(l*t,e[0].length*t);for(var o=0;o<=e[0].length;o++)r.moveTo(0,o*t),r.lineTo(e.length*t,o*t);return r.stroke(),n.transferToImageBitmap()}function setMenu(e,t){if(document.getElementById(e)){for(var n=0;n<document.getElementById(e).children[1].children.length;n++)document.getElementById(e).children[1].children[n].style.display="block";document.getElementById(e).children[1].children[t].style.display="none",document.getElementById(e).children[0].innerHTML=document.getElementById(e).children[1].children[t].innerHTML}}function searchAction(e){var t=e.getElementsByClassName("condition");if(t.length<=1)return-1;for(var n=0;n<t.length-1;n++)if(!0!==t[n].condition(e)==("When"===t[n].previousElementSibling.children[0].innerText))return-2;return e.action(e),0}function integerDomainToArray(e){for(var t=e.split(","),n=0;n<t.length;n++)if(t[n].split("").includes("-")){for(var r=t[n].split("-").map(function(e){return parseInt(e)}),a=new Array(r[1]-r[0]+1),i=0;i<a.length;i++)a[i]=r[0]+i;t[n]=a}else t[n]=parseInt(t[n]);return t.flat()}function setSalvoIteration(e,t){var n,r,a,i=e.info;if("Active Paste"===e.children[3].children[0].innerHTML){if(!1===pasteArea.isActive)return-1;if(null===clipboard[activeClipboard].shipInfo.dx){if(clipboard[activeClipboard].shipInfo=findShip(clipboard[activeClipboard].pattern,pasteArea),i.minAppend=0,i.minIncrement=0,i.progress=[{delay:[0],repeatedResult:!1,result:null}],0===(a=clipboard[activeClipboard].shipInfo).period)return alert("Couldn't find ship. I need an area that contains only the spaceship."),-1;alert("Found (".concat([Math.abs(a.dx),Math.abs(a.dy)],")c/").concat(a.period))}a=clipboard[activeClipboard].shipInfo,n=pasteArea.left+a.shipOffset.x,r=pasteArea.top+a.shipOffset.y}else if(e.children[3].children[0].innerHTML.match(/Marker .+/)){if(0===(c=markers[parseInt(e.children[3].children[0].innerHTML.slice(7))-1]).isActive)return-1;if(null===c.shipInfo.dx){if(c.shipInfo=findShip(c.pattern,c),i.minAppend=0,i.minIncrement=0,i.progress=[{delay:[0],repeatedResult:!1,result:null}],0===(a=clipboard[activeClipboard].shipInfo).period)return alert("Couldn't find ship. I need an area that contains only the spaceship."),-1;alert("Found ".concat([Math.abs(a.dx),Math.abs(a.dy)],"c/").concat(a.period))}a=c.shipInfo,n=c.left+a.shipOffset.x,r=c.top+a.shipOffset.y}if(0===a.dx&&0===a.dy)return alert("Still Life/Oscillator Dectected. I can only use patterns which move to make a salvo."),-1;t+1<i.progress.length&&(i.progress=[{delay:[0],repeatedResult:!1,result:null}],i.minIncrement=0,i.minAppend=0);for(var l=i.progress.length;l<t+1;l++)incrementSearch(i);for(var o={top:0,right:0,bottom:0,left:0},c=-Math.ceil(i.progress.slice(-1)[0].delay.slice(-1)[0]/a.period),s=(o.top=r+Math.min(0,c*a.dy),o.right=n+Math.max(0,c*a.dx)+a.phases[0].length,o.bottom=r+Math.max(0,c*a.dy)+a.phases[0][0].length,o.left=n+Math.min(0,c*a.dx),GRID.head=widenTree(o),new Array(o.right-o.left)),d=0;d<s.length;d++)s[d]=new Array(o.bottom-o.top),s[d].fill(0);c=readPattern(o.top,o.right,o.bottom,o.left),writePattern(o.left,o.top,s,GRID);for(var h=0;h<i.progress.slice(-1)[0].delay.length;h++){var p=i.progress.slice(-1)[0].delay[h]/a.period,u=i.progress.slice(-1)[0].delay[h]/a.period;writePattern(n-Math.ceil(p)*a.dx+0*Math.min(0,a.dx),r-Math.ceil(u)*a.dy+0*Math.min(0,a.dy),a.phases[mod(-i.progress.slice(-1)[0].delay[h],a.period)],GRID)}socket&&socket.emit("paste",Date.now(),{newPatt:[o.left,o.top,readPattern(o.top,o.right,o.bottom,o.left)],oldPatt:[o.left,o.top,c]}),e.children[4].value=t,currentEvent=new EventNode(currentEvent,"generate salvo"),0===isPlaying&&render()}function duplicateLastChild(e){e.appendChild(e.lastElementChild.cloneNode(!0))}function setGridType(e){var t=exportPattern();GRID.type=e,socket&&socket.emit("changeGrid",GRID.type),console.log("importGridPattern"),importPattern(t.pattern,t.xOffset,t.yOffset),currentEvent=new EventNode(currentEvent,"changeGrid")}function changeCondition(e){for(var n=[{name:"Reset",condition:function(){return wasReset}},{name:"Pattern Stablizes",condition:function(e,t){for(var n=currentEvent.parent,r=integerDomainToArray(t.children[e+1].value),a=1;a<100&&n;a++){if(GRID.head===n.head){if(r.includes(a))break;return!0}n=n.parent}return!1}},{name:"Generation",condition:function(e,t){return genCount>=parseInt(t.children[e+1].value)}},{name:"Population",condition:function(e,t){return t=integerDomainToArray(t.children[e+1].value),0===GRID.type?t.includes(GRID.head.population):t.includes(gridPopulation)}},{name:"Pattern Contains",condition:function(e,t){var n,r=[];return"Select Area"===t.children[e+1].children[0].innerHTML&&selectArea.isActive?r=readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left):t.children[e+1].children[0].innerHTML.includes("Marker")?r=0!==(n=markers[parseInt(t.children[e+1].children[0].innerHTML.slice(7))-1]).activeState?readPattern(n.top,n.right,n.bottom,n.left):[]:t.children[e+1].children[0].innerHTML.includes("Copy Slot")&&(r=clipboard[parseInt(t.children[e+1].children[0].innerHTML.slice(10))].pattern),!(!r||0===r.length)&&("Select Area"===t.children[e+2].children[0].innerHTML?selectArea.isActive&&-1!==findPattern(readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left),r).x:!!t.children[e+2].children[0].innerHTML.includes("Marker")&&0!==(n=markers[parseInt(t.children[e+2].children[0].innerHTML[7])-1]).activeState&&-1!==findPattern(readPattern(n.top,n.right,n.bottom,n.left),r).x)}}],r=e.parentElement.parentElement;r.nextSibling;)r.nextSibling.remove();replaceDropdownElement(e);for(var a=Array.from(r.parentElement.children).indexOf(r),t=0;t<n.length&&!function(t){return n[t].name===e.innerText&&(r.condition=function(e){return n[t].condition(a,e)},r.parentElement.appendChild(document.getElementById(n[t].name+" Condition Template").content.cloneNode(!0)),r.parentElement.appendChild(document.getElementById("conditionHTML").content.cloneNode(!0)),1)}(t);t++);updateSelectors()}function changeAction(e){for(var t=[{name:"Reset",action:function(){reset(!1)}},{name:"Shift",action:function(e){"Select Area"===e.children[2].children[0].innerHTML?(selectArea.top+=parseInt(e.children[4].value),selectArea.right+=parseInt(e.children[3].value),selectArea.bottom+=parseInt(e.children[4].value),selectArea.left+=parseInt(e.children[3].value)):"Paste Area"===e.children[2].children[0].innerHTML&&pasteArea.isActive&&(pasteArea.top+=parseInt(e.children[4].value),pasteArea.left+=parseInt(e.children[3].value),currentEvent=writePatternAndSave(pasteArea.left,pasteArea.top,clipboard[activeClipboard].pattern),socket)&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste)}},{name:"Randomize",action:function(e){selectArea.isActive&&"Select Area"===e.children[2].children[0].innerHTML?randomizeGrid(selectArea):e.children[2].children[0].innerHTML.includes("Marker")&&0!==(e=markers[parseInt(e.children[2].children[0].innerHTML[7])-1]).activeState&&randomizeGrid(e),currentEvent=new EventNode(currentEvent,"randomize")}},{name:"Save Pattern",action:function(){""===document.getElementById("rle").value&&(document.getElementById("rle").value="x = 0, y = 0, rule = "+exportRulestring()+"\n"),document.getElementById("rle").value=appendRLE(exportRLE())}},{name:"Generate Salvo",Info:_createClass(function e(){_classCallCheck(this,e),this.repeatTime=0,this.minIncrement=0,this.minAppend=0,this.progress=[{delay:[0],repeatedResult:!1,result:null}]}),action:function(e){setSalvoIteration(e,parseInt(e.children[4].value)+1)}},{name:"Increment Area",action:function(e){selectArea.isActive&&"Select Area"===e.children[2].children[0].innerHTML?incrementArea(selectArea):e.children[2].children[0].innerHTML.includes("Marker")&&0!==(e=markers[parseInt(e.children[2].children[0].innerHTML[7])-1]).activeState&&incrementArea(e),currentEvent=new EventNode(currentEvent,"increment area")}}],n=e.parentElement.parentElement.parentElement;e.parentElement.parentElement.nextSibling;)e.parentElement.parentElement.nextSibling.remove();document.getElementById("searchOptions").lastElementChild===n&&duplicateLastChild(document.getElementById("searchOptions")),replaceDropdownElement(e);for(var r=0;r<t.length;r++)if(t[r].name===e.innerText){n.action=t[r].action,n.conditions=[],n.appendChild(document.getElementById(t[r].name+" Action Template").content.cloneNode(!0)),n.appendChild(document.getElementById("conditionHTML").content.cloneNode(!0)),"Reset"!==e.innerText&&(n.lastElementChild.children[1].innerHTML+="<button onclick='changeCondition(this);'>Reset</button>"),!t[r].Info||"info"in n?!t[r].Info&&"info"in n&&(delete n.info,console.log(n),console.log("deleted info property from an element which shouldn't have it")):(console.log("init ship"),n.info=new t[r].Info(n));break}updateSelectors()}function replaceDropdownElement(e){var t=e.parentElement;t.previousElementSibling.innerHTML=e.innerHTML;for(var n=0;n<t.children.length;n++)t.children[n].style.display="block";e.style.display="none"}function showPreview(e){var t=e.lastElementChild,e=parseInt(e.innerText);clipboard[e].pattern[0]&&(null===clipboard[e].previewBitmap&&(clipboard[e].previewBitmap=patternToBitmap(clipboard[e].pattern)),t.width=clipboard[e].previewBitmap.width,t.height=clipboard[e].previewBitmap.height,t.getContext("2d").drawImage(clipboard[e].previewBitmap,0,0))}function changeCopySlot(e){var t=e.parentElement;document.getElementById("copyMenu").lastElementChild===e&&(duplicateLastChild(t),t.lastElementChild.innerHTML="".concat(t.children.length,'<canvas class="patternPreview"></canvas>'),clipboard.push({pattern:[],shipInfo:{dx:null,dy:null,phases:[]},previewBitmap:null})),activeClipboard=parseInt(e.innerText),replaceDropdownElement(e),updateSelectors(),0===isPlaying&&render()}function changeGridType(e){var t=e.parentElement,t=Array.from(t.children).indexOf(e);GRID.type!==t&&setGridType(t),replaceDropdownElement(e),0===isPlaying&&render()}function changeDrawMode(e){var t=e.parentElement;-1<(drawMode=Array.from(t.children).indexOf(e)-1)&&(document.getElementById("drawMenu").children[0].style.backgroundColor=getColor(drawMode)),drawMode>.8*rule.length||0===drawMode||-1===drawMode?document.getElementById("drawMenu").children[0].style.color=darkMode?"#bbb":"#000":document.getElementById("drawMenu").children[0].style.color=darkMode?"#000":"#bbb",replaceDropdownElement(e)}function deleteOption(e){(e="BUTTON"===(e=e.parentElement).nodeName?e.parentElement:e)!==e.parentElement.lastElementChild&&e.remove(),"info"in e&&delete e.info}function widenTree(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:GRID.head,n=0;;n++){if(maxDepth<n){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(!(-t.distance>4*e.top||t.distance<=4*e.right||t.distance<=4*e.bottom||-t.distance>4*e.left))break;t=doubleSize(t)}return t}function selectAll(){var e;0!==GRID.head.value&&(pasteArea.isActive=!1,selectArea.isActive=!0,setActionMenu(),0===GRID.type?(selectArea.top=(null!=(e=getTopBorder(GRID.head))?e:0)/2-.5,selectArea.right=(null!=(e=getRightBorder(GRID.head))?e:0)/2+.5,selectArea.bottom=(null!=(e=getBottomBorder(GRID.head))?e:0)/2+.5,selectArea.left=(null!=(e=getLeftBorder(GRID.head))?e:0)/2-.5):(selectArea.top=GRID.finiteArea.top,selectArea.right=GRID.finiteArea.right,selectArea.bottom=GRID.finiteArea.bottom,selectArea.left=GRID.finiteArea.left),0===isPlaying)&&render()}function findPattern(e,t){for(var n=0;n<e.length-t.length+1;n++)for(var r=0;r<e[0].length-t[0].length+1;r++){for(var a=!1,i=0;i<t.length;i++){for(var l=0;l<t[0].length;l++)if(t[i][l]!==e[n+i][r+l]){a=!0;break}if(a)break}if(!1===a)return{x:n,y:r}}return{x:-1,y:-1}}function copy(){pasteArea.isActive?resetClipboard():!0===selectArea.isActive&&(GRID.head=widenTree(selectArea),clipboard[activeClipboard].pattern=readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left),clipboard[activeClipboard].previewBitmap=patternToBitmap(clipboard[activeClipboard].pattern),pasteArea.top=selectArea.top,pasteArea.left=selectArea.left,clipboard[activeClipboard].shipInfo={dx:null,dy:null,phases:[],period:0},selectArea.isActive=!1,setActionMenu(),render())}function cut(){if(pasteArea.isActive)resetClipboard();else if(!0===selectArea.isActive){GRID.head=widenTree(selectArea),clipboard[activeClipboard].pattern=readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left),pasteArea.top=selectArea.top,pasteArea.left=selectArea.left;for(var e=new Array(selectArea.right-selectArea.left),t=0;t<e.length;t++)e[t]=new Array(selectArea.bottom-selectArea.top),e[t].fill(0);currentEvent=writePatternAndSave(selectArea.left,selectArea.top,e),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste),isPlaying=0,selectArea.isActive=!1,setActionMenu(),render()}}function paste(){captureScroll=!0,clipboard[activeClipboard]&&0!==clipboard[activeClipboard].pattern.length&&(pasteArea.isActive?(currentEvent=writePatternAndSave(pasteArea.left,pasteArea.top,clipboard[activeClipboard].pattern),console.log(currentEvent),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste)):(selectArea.isActive=!1,pasteArea.isActive=!0,editMode=1,0===isPlaying&&render()),setActionMenu())}function randomizeGrid(e){for(var t=new Array(e.right-e.left),n=0;n<t.length;n++){t[n]=new Array(e.bottom-e.top);for(var r=0;r<t[0].length;r++)Math.random()<document.getElementById("density").value/100?t[n][r]=1:t[n][r]=0}currentEvent=writePatternAndSave(e.left,e.top,t),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste),render()}function incrementArea(e){var t=readPattern(e.top-1,e.right+1,e.bottom+1,e.left-1);currentEvent=writePatternAndSave(e.left,e.top,iteratePattern(t,1,t.length-1,t[0].length-1,1)),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste),render()}function clearGrid(){if(!0===selectArea.isActive){for(var e=new Array(selectArea.right-selectArea.left),t=0;t<e.length;t++)e[t]=new Array(selectArea.bottom-selectArea.top),e[t].fill(0);currentEvent=writePatternAndSave(selectArea.left,selectArea.top,e),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste)}render()}function invertGrid(){if(pasteArea.isActive)resetClipboard();else if(!0===selectArea.isActive){GRID.head=widenTree(selectArea);for(var e=readPattern(selectArea.top,selectArea.right,selectArea.bottom,selectArea.left),t=0;t<e.length;t++)for(var n=0;n<e[0].length;n++)0!==e[t][n]&&1!==e[t][n]||(e[t][n]=1-e[t][n]);currentEvent=writePatternAndSave(selectArea.left,selectArea.top,e),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste)}isPlaying=0,render()}function flipDiag(){for(var e=new Array(clipboard[activeClipboard].pattern[0].length),t=0;t<e.length;t++){e[t]=new Array(clipboard[activeClipboard].pattern.length);for(var n=0;n<e[0].length;n++)e[t][n]=clipboard[activeClipboard].pattern[n][t]}pasteArea.left-=Math.trunc(e.length/2-e[0].length/2),pasteArea.top+=Math.trunc(e.length/2-e[0].length/2),clipboard[activeClipboard].pattern=e}function flipOrtho(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"horizonal",t=(clipboard[activeClipboard].pattern.length,new Array(clipboard[activeClipboard].pattern.length)),n=0;n<t.length;n++){t[n]=new Array(clipboard[activeClipboard].pattern[0].length);for(var r=0;r<t[0].length;r++)t[n][r]="horizonal"===e?clipboard[activeClipboard].pattern[clipboard[activeClipboard].pattern.length-1-n][r]:clipboard[activeClipboard].pattern[n][clipboard[activeClipboard].pattern[0].length-1-r]}clipboard[activeClipboard].pattern=t,0===isPlaying&&render()}function updateSelectors(){for(var e=document.getElementsByClassName("dropdown-content"),t=0;t<e.length;t++){var n=0;if((e[t].className.includes("pattern-marker")||e[t].className.includes("areas"))&&n++,e[t].className.includes("areas"))for(var r,a=0;a<markers.length;a++)n>=e[t].children.length?0<markers[a].activeState&&0===markers[a].pattern.length&&(e[t].innerHTML+='<button onclick="replaceDropdownElement(this);updateSelectors();">Marker '.concat(a+1,"</button>"),n++):(r=parseInt(e[t].children[n].innerHTML.slice(7))-1,0<markers[a].activeState&&0===markers[a].pattern.length&&a!==r?(e[t].children[n-1].insertAdjacentHTML("afterend",'<button onclick="replaceDropdownElement(this);updateSelectors();">Marker '.concat(a+1,"</button>")),n++):0<markers[a].activeState&&0===markers[a].pattern.length&&a===r?n++:0!==markers[a].activeState&&0!==markers[a].pattern.length||a!==r||e[t].children[n].remove());if(e[t].className.includes("pattern-marker"))for(var i,l=0;l<markers.length;l++)n>=e[t].children.length?0<markers[l].activeState&&0!==markers[l].pattern.length&&(e[t].innerHTML+='<button onclick="replaceDropdownElement(this);updateSelectors();">Marker '.concat(l+1,"</button>"),n++):(i=parseInt(e[t].children[n].innerHTML.slice(7))-1,0<markers[l].activeState&&0!==markers[l].pattern.length&&l!==i?(e[t].children[n-1].insertAdjacentHTML("afterend",'<button onclick="replaceDropdownElement(this);updateSelectors();">Marker '.concat(l+1,"</button>")),n++):0<markers[l].activeState&&0!==markers[l].pattern.length&&l===i?n++:0!==markers[l].activeState&&0===markers[l].pattern.length||l!==i||e[t].children[n].remove());if(e[t].className.includes("copy-slot"))for(var o=1;o<clipboard.length-1;o++)n>=e[t].children.length&&(e[t].innerHTML+='<button onclick="replaceDropdownElement(this);">Copy Slot '.concat(o,"</button>"),n++)}}function deleteMarker(){for(var e=0;e<markers.length;e++)2===markers[e].activeState&&(markers[e]={activeState:0,top:0,right:0,bottom:0,left:0,shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0},pattern:[]});updateSelectors(),setActionMenu(),render()}function fitView(){var e,t,n,r=0===GRID.type?(e=(null!=(e=getTopBorder(GRID.head))?e:0)/2-.5,t=(null!=(t=getRightBorder(GRID.head))?t:0)/2+.5,n=(null!=(n=getBottomBorder(GRID.head))?n:0)/2+.5,(null!=(r=getLeftBorder(GRID.head))?r:0)/2-.5):(e=GRID.finiteArea.top,t=GRID.finiteArea.right,n=GRID.finiteArea.bottom,GRID.finiteArea.left);!e&&0!==e||(view.x=(t+r-canvasWidth/cellWidth)/2,view.y=(n+e-canvasHeight/cellWidth)/2,view.touchX=0,view.touchY=0,view.z=Math.min(canvasWidth/cellWidth/(t-r+2),canvasHeight/cellWidth/(n-e+2)),view.touchZ=view.z,updateLines(),socket&&null===resetEvent&&(socket.emit("pan",{id:clientId,xPosition:view.x,yPosition:view.y}),socket.emit("zoom",{id:clientId,zoom:view.z})),0!==isPlaying)||render()}function setMark(){if(!0===pasteArea.isActive){for(var e=0;e<markers.length;e++)if(0===markers[e].activeState){pasteArea.isActive=!1,setActionMenu(),markers[e].activeState=1,markers[e].top=pasteArea.top,markers[e].right=pasteArea.left+clipboard[activeClipboard].pattern.length,markers[e].bottom=pasteArea.top+clipboard[activeClipboard].pattern[0].length,markers[e].left=pasteArea.left,markers[e].pattern=clipboard[activeClipboard].pattern;break}updateSelectors()}else if(!0===selectArea.isActive){for(var t=0;t<markers.length;t++)if(0===markers[t].activeState){selectArea.isActive=!1,setActionMenu(),markers[t]={activeState:1,top:selectArea.top,right:selectArea.right,bottom:selectArea.bottom,left:selectArea.left,shipInfo:{dx:null,dy:null,shipOffset:null,phases:[],period:0},pattern:[]};break}updateSelectors()}0===isPlaying&&render()}function isElementCheckedById(e){return document.getElementById(e).checked}function setDark(){document.getElementById("darkTheme").checked?(darkMode=1,canvas.style.backgroundColor=!0===detailedCanvas?"#222":"#2c2c2c",document.getElementById("LightTheme").disabled=!0,document.getElementById("DarkTheme").disabled=!1):(darkMode=0,canvas.style.backgroundColor=!0===detailedCanvas?"#f1f1f1":"#ddd",document.getElementById("LightTheme").disabled=!1,document.getElementById("DarkTheme").disabled=!0),setDrawMenu(),render()}function next(){0===isPlaying&&(isPlaying=-1,main())}function start(){isPlaying=0===isPlaying?1:0}function setEvent(e){if("type"in e)"generation"in e&&(genCount=e.generation,document.getElementById("gens").innerHTML="Generation "+genCount),"backgroundState"in e&&(GRID.backgroundState=e.backgroundState),"resetEvent"in e&&(resetEvent=e.resetEvent),"type"in e&&(GRID.type=e.type,setMenu("gridMenu",GRID.type),emptyNodes=emptyNodes.map(function(){return null}),0===GRID.type?(GRID.head=e.head,document.getElementById("population").innerHTML="Population "+GRID.head.population):("string"==typeof e.finiteArray?GRID.finiteArray=readRLE(e.finiteArray):GRID.finiteArray=e.finiteArray,GRID.finiteArea.top=e.finiteArea.top,GRID.finiteArea.right=e.finiteArea.right+GRID.finiteArray.length,GRID.finiteArea.bottom=e.finiteArea.bottom+GRID.finiteArray[0].length,GRID.finiteArea.left=e.finiteArea.left,GRID.finiteArea.margin=1===GRID.type?1:0));else if(setEvent(e.parent),"draw"in e){for(var t=0;t<e.draw.length;t++)writePattern(e.draw[t].x,e.draw[t].y,[[e.draw[t].newState]],GRID);socket&&null===resetEvent&&socket.emit("draw",Date.now(),e.draw)}else"paste"in e&&(writePattern.apply(void 0,_toConsumableArray(e.paste.newPatt).concat([GRID])),socket)&&null===resetEvent&&socket.emit("paste",Date.now(),e.paste);currentEvent=e}function undo(){if(null!==currentEvent.parent){if("draw"in currentEvent){for(var e=0;e<currentEvent.draw.length;e++)writePattern(currentEvent.draw[e].x,currentEvent.draw[e].y,[[currentEvent.draw[e].oldState]],GRID);socket&&null===resetEvent&&socket.emit("undoDraw",Date.now(),currentEvent.draw),currentEvent=currentEvent.parent}else"paste"in currentEvent?(writePattern.apply(void 0,_toConsumableArray(currentEvent.paste.oldPatt).concat([GRID])),socket&&null===resetEvent&&socket.emit("undoPaste",Date.now(),currentEvent.paste),currentEvent=currentEvent.parent):setEvent(currentEvent.parent);null!==resetEvent&&resetEvent.parent===currentEvent.parent&&(resetEvent=null)}isPlaying=0,render()}function redo(){if(null!==currentEvent.child)if("draw"in currentEvent.child){currentEvent=currentEvent.child;for(var e=0;e<currentEvent.draw.length;e++)writePattern(currentEvent.draw[e].x,currentEvent.draw[e].y,[[currentEvent.draw[e].newState]],GRID);socket&&null===resetEvent&&socket.emit("draw",Date.now(),currentEvent.draw)}else"paste"in currentEvent.child?(currentEvent=currentEvent.child,writePattern.apply(void 0,_toConsumableArray(currentEvent.paste.newPatt).concat([GRID])),socket&&null===resetEvent&&socket.emit("paste",Date.now(),currentEvent.paste)):setEvent(currentEvent.child);isPlaying=0,render()}function reset(){for(var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=document.getElementById("searchOptions").children,n=0;n<t.length;n++)if(-1!==Array.from(t[n].getElementsByClassName("condition")).findIndex(function(e){return"Reset"===e.children[0].innerHTML})&&t[n].info){t[n].info.progress.slice(-1)[0].result=GRID.head;for(var r=0;r<t[n].info.progress.length-2;r++)if(GRID.head===t[n].info.progress[r].result){t[n].info.progress.slice(-1)[0].repeatedResult=!0;break}break}null!==resetEvent&&(setEvent(resetEvent),resetEvent=null,GRID.backgroundState=0),wasReset=!0,e&&(isPlaying=0),render()}function resetActions(){if(!1!==isElementCheckedById("userReset")){for(var e=document.getElementById("searchOptions").getElementsByClassName("condition"),t=0;t<e.length;t++)if(e[t].children[0]&&"Reset"===e[t].children[0].innerHTML){searchAction(e[t].parentElement);break}0===isPlaying&&render()}}function incrementSearch(e){0===e.progress.slice(-1)[0].delay.slice(-1)[0]?(e.progress.push({delay:[0,e.repeatTime],repeatedResult:!1,result:null}),e.minIncrement=1,e.minAppend=1):e.repeatTime<=e.progress[e.minIncrement].delay.slice(-1)[0]-e.progress[e.minAppend].delay.slice(-1)[0]?(e.progress.push({delay:[].concat(_toConsumableArray(e.progress[e.minAppend].delay),[e.progress[e.minAppend].delay.slice(-1)[0]+e.repeatTime]),repeatedResult:!0,result:null}),e.minAppend++):(e.progress.push({delay:_toConsumableArray(e.progress[e.minIncrement].delay),repeatedResult:!1,result:null}),e.progress.slice(-1)[0].delay[e.progress.slice(-1)[0].delay.length-1]++,e.minIncrement++)}function appendRLE(e){for(var t=document.getElementById("rle").value,n=(t=t.replace("!","").replace(/x *= *[0-9]+, *y *= *[0-9]+,/,"x = 0, y = 0,")).length;"\n"!==t[n]&&0<n;)n--;for(n+=70,t+=document.getElementById("rleMargin").value+"$"+e.replace(/.+\n/,"").replace(/\n/g,"");n<t.length;){for(;!isNaN(t[n])&&0<n;)n--;t=t.slice(0,n+1)+"\n"+t.slice(n+1),n+=70}return t}function menu(e){"block"===document.getElementById("menu".concat(e.toString())).style.display?(document.getElementById("arrow".concat(e.toString())).innerHTML="&#x27A1",document.getElementById("menu".concat(e.toString())).style.display="none"):(document.getElementById("arrow".concat(e.toString())).innerHTML="&#x2B07",document.getElementById("menu".concat(e.toString())).style.display="block")}function save(){document.getElementById("rule").value!==rulestring&&""!==document.getElementById("rule").value&&(setRule(document.getElementById("rule").value),socket&&socket.emit("rule",rulestring),isPlaying=0),document.getElementById("step").value&&(isNaN(document.getElementById("step").value)?alert("Genertions Per Update must be a number"):stepSize=parseInt(document.getElementById("step").value,10)),render()}function getCell(e,t,n){for(var r=e,a=t,i=n,l=0;;l++){if(maxDepth<l){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(i<0)if(a<0){if(!(r.child[0]&&a>=-r.distance&&i>=-r.distance))return null;if(a+=(r=r.child[0]).distance,i+=r.distance,1===r.distance)return r}else{if(!(r.child[1]&&a<r.distance&&i>=-r.distance))return null;if(a-=(r=r.child[1]).distance,i+=r.distance,1===r.distance)return r}else if(a<0){if(!(r.child[2]&&a>=-r.distance&&i<r.distance))return null;if(a+=(r=r.child[2]).distance,i-=r.distance,1===r.distance)return r}else{if(!(r.child[3]&&a<r.distance&&i<r.distance))return null;if(a-=(r=r.child[3]).distance,i-=r.distance,1===r.distance)return r}}}function writePatternToGrid(e,t,n,r){var a,i=[-1,1,-1,1],l=[-1,-1,1,1];if(1===r.distance)return e<=0&&e+.5>-n.length&&t<=0&&t+.5>-n[0].length?((a=new TreeNode(r.distance)).value=n[-e-.5][-t-.5],writeNode(a)):r;for(var o=new TreeNode(r.distance),c=0;c<4;c++)0<t&&c<2||e<-n.length&&c%2==1||0<e&&c%2==0||t<-n[0].length&&3<c?o.child[c]=r.child[c]:o.child[c]=writePatternToGrid(e-r.distance*i[c]*.25,t-r.distance*l[c]*.25,n,r.child[c]);return o.value=getValue(o),writeNode(o)}function readSubpattern(e,t,n,r,a){for(var i=new Array(n-a),l=0;l<i.length;l++){i[l]=new Array(r-t);for(var o=0;o<i[l].length;o++)i[l][o]=e[l+a][o+t]}return i}function readPattern(e,t,n,r){var a=new Array(t-r);if(0===GRID.type)for(var i=(void 0===arguments[4]?GRID:arguments[4]).head,l=0;l<a.length;l++){a[l]=new Array(n-e);for(var o=0;o<a[l].length;o++){var c=getCell(i,2*(r+l),2*(e+o));a[l][o]=null!==c?c.value:GRID.backgroundState}}else for(var s=(void 0!==arguments[4]?arguments[4]:GRID).finiteArray,d=(void 0!==arguments[4]?arguments[4]:GRID).finiteArea.margin,h=(void 0!==arguments[4]?arguments[4]:GRID).finiteArea.left,p=(void 0!==arguments[4]?arguments[4]:GRID).finiteArea.top,u=0;u<a.length;u++){a[u]=new Array(n-e);for(var f=0;f<a[u].length;f++)p-d<=f+e&&u+r<h+s.length+d&&f+e<p+s[0].length+d&&h-d<=u+r?a[u][f]=s[u-h+d+r][f-p+d+e]:a[u][f]=arguments[4]?0:GRID.backgroundState}return a}function writePatternAndSave(e,t,n){if(!n||0===n.length)return currentEvent;var r=readPattern(t,e+n.length,t+n[0].length,e,GRID);if(0===GRID.type)GRID.head=widenTree({top:t,right:e+n.length,bottom:t+n[0].length,left:e},GRID.head),GRID.head=writePatternToGrid(e,t,n,GRID.head);else{for(var a=!1,i=0;i<n.length;i++)for(var l=0;l<n[0].length;l++)l+t>=GRID.finiteArea.top-GRID.finiteArea.margin&&i+e<GRID.finiteArea.right+GRID.finiteArea.margin&&l+t<GRID.finiteArea.bottom+GRID.finiteArea.margin&&i+e>=GRID.finiteArea.left-GRID.finiteArea.margin&&(GRID.finiteArray[i-GRID.finiteArea.left+GRID.finiteArea.margin+e][l-GRID.finiteArea.top+GRID.finiteArea.margin+t]=n[i][l],a=!0);if(!1===a)return currentEvent}return new EventNode(currentEvent,Date.now(),"paste",{newPatt:[e,t,n],oldPatt:[e,t,r]})}function writePattern(e,t,n,r){if(0!==r.type)for(var a=0;a<n.length;a++)for(var i=0;i<n[0].length;i++)i+t>=r.finiteArea.top-r.finiteArea.margin&&a+e<r.finiteArea.left+r.finiteArray.length-r.finiteArea.margin&&i+t<r.finiteArea.top+r.finiteArray[0].length-r.finiteArea.margin&&a+e>=r.finiteArea.left-r.finiteArea.margin&&(r.finiteArray[a-r.finiteArea.left+r.finiteArea.margin+e][i-r.finiteArea.top+r.finiteArea.margin+t]=n[a][i]);else r.head=widenTree({top:t,right:e+n.length,bottom:t+n[0].length,left:e},r.head),r.head=writePatternToGrid(e,t,n,r.head)}function getTopBorder(e){var t=[-1,-1,1,1];if(1===e.distance)return 0!==e.value?0:null;for(var n,r=null,a=0;a<4;a++)null!==(n=getTopBorder(e.child[a]))&&(null===r||r>(e.distance>>1)*t[a]+n)&&(r=(e.distance>>1)*t[a]+n);return r}function getRightBorder(e){var t=[-1,1,-1,1];if(1===e.distance)return 0!==e.value?0:null;for(var n,r=null,a=0;a<4;a++)null!==(n=getRightBorder(e.child[a]))&&(null===r||r<(e.distance>>1)*t[a]+n)&&(r=(e.distance>>1)*t[a]+n);return r}function getBottomBorder(e){var t=[-1,-1,1,1];if(1===e.distance)return 0!==e.value?0:null;for(var n,r=null,a=0;a<4;a++)null!==(n=getBottomBorder(e.child[a]))&&(null===r||r<(e.distance>>1)*t[a]+n)&&(r=(e.distance>>1)*t[a]+n);return r}function getLeftBorder(e){var t=[-1,1,-1,1];if(1===e.distance)return 0!==e.value?0:null;for(var n,r=null,a=0;a<4;a++)null!==(n=getLeftBorder(e.child[a]))&&(null===r||r>(e.distance>>1)*t[a]+n)&&(r=(e.distance>>1)*t[a]+n);return r}function patternToBaseN(e){var t="",n=0,r=rule.length;if(0!==e.length)for(var a=52..toString(r).length-1,i=0;i<e[0].length;i+=a)for(var l=0;l<e.length;l++){for(var o=0;o<a&&i+o<e[0].length;o++)n+=e[l][i+o]*Math.pow(r,o);t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"[n],n=0}return t}function baseNToPattern(e,t,n){for(var r=new Array(e),a=0,i=rule.length,l=0,o=0;o<e;o++)r[o]=new Array(t);for(var c=52..toString(i).length-1,s=0;s<t;s+=c)for(var d=0;d<e;d++){if(l>=n.length)return console.log("baseN parseing error: string too long for dimensions"),r;a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".indexOf(n[l]),l++;for(var h=0;h<c&&s+h<t;h++)r[d][s+h]=a%i,a=Math.floor(a/i)}return r}function LZ77ToBaseN(e){for(var t="",n=0,r=0,a=0;a<e.length&&a<maxDepth;a++)if(isNaN(e[a]))"~"!==e[a]&&(t+=e[a]);else if(n=10*n+parseInt(e[a]),isNaN(e[a+1])){if("~"===e[a+1])r=n;else{for(var i=0;i<n;i++)t+=t[t.length-r-1];r=0}n=0}return t}function baseNToLZ77(e){for(var t="",n=0;n<e.length;n++){for(var r=0,a=1,i=0;i<n+1;i++)for(var l=e.slice(n-i,n+1),o=0;;o++)if(n+o+1>=e.length||l[o%l.length]!==e[n+o+1]){a<o&&i<o&&(r=i,a=o);break}t+=e[n],(1<a&&0===r||a>a.toString().length+r.toString().length+1)&&(0!==r&&(t+="".concat(r,"~")),t+="".concat(a),n+=a)}return t}function exportRulestring(){return document.getElementById("BSG").checked?2===rule.length?clean(rulestring).replace(/g[0-9]*/g,""):clean(rulestring):document.getElementById("gbs").checked?2===rule.length?clean(rulestring).replace(/B([0-8aceijknqrtwyz-]*)\/S([0-8aceijknqrtwyz-]*)\/G([0-9]*)/g,"b$1s$2"):clean(rulestring).replace(/B([0-8aceijknqrtwyz-]*)\/S([0-8aceijknqrtwyz-]*)\/G([0-9]*)/g,"g$3b$1s$2"):document.getElementById("sbg").checked?2===rule.length?clean(rulestring).replace(/B([0-8aceijknqrtwyz-]*)\/S([0-8aceijknqrtwyz-]*)\/G([0-9]*)/g,"$2/$1"):clean(rulestring).replace(/B([0-8aceijknqrtwyz-]*)\/S([0-8aceijknqrtwyz-]*)\/G([0-9]*)/g,"$2/$1/$3"):rulestring}function patternToRLE(e){if(0===e.length)return"x = 0, y = 0, rule = ".concat(exportRulestring(),"\n!");var t="x = ".concat(e.length,", y = ").concat(e[0].length,", rule = ").concat(exportRulestring()),n=0;1===GRID.type&&(t+=":P".concat(e.length,",").concat(e[0].length)),2===GRID.type&&(t+=":T".concat(e.length,",").concat(e[0].length)),t+="\n";for(var r=0;r<e[0].length;r++){for(var a=0,i=e.length-1;0<=i;i--)if(0!==e[i][r]){1<n&&(t+=n),a=i+1;break}if(0===a)n++;else{0!==n&&(t+="$",n=0);for(var l=0;l<a;l++)n++,l!==a-1&&e[l][r]===e[l+1][r]||(1<n&&(t+=n),2!==rule.length||/.+(Super)|(History)$/g.test(rulestring)?0===e[l][r]?t+=".":t+=String.fromCharCode(64+e[l][r]):0===e[l][r]?t+="b":t+="o",n=0);n=1}}for(var t=t.split(""),o=0,c=0;c<t.length;c++){if(0===c)for(;"\n"!==t[c]&&c<t.length;)c++;if(o++,70<(o="\n"===t[c]?0:o))for(var s=0;s<70;s++)if(isNaN(t[c-s-1])){t.splice(c-s,0,"\n"),o=s;break}}return t.join("")+"!"}function zoom(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5*canvasWidth,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:.5*canvasHeight,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:view.x,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:view.y,i=5<arguments.length&&void 0!==arguments[5]?arguments[5]:view.z;view.z=i*e,view.x=r+(t-.5*canvasWidth)*(e-1)/e/cellWidth/i,view.y=a+(n-.5*canvasHeight)*(e-1)/e/cellWidth/i,socket&&null===resetEvent&&socket.emit("zoom",{id:clientId,zoom:view.z}),updateLines()}function updateLines(){view.z<.2&&!0===detailedCanvas?(detailedCanvas=!1,canvas.style.backgroundColor=darkMode?"#2c2c2c":"#ddd"):.2<view.z&&!1===detailedCanvas&&(detailedCanvas=!0,canvas.style.backgroundColor=darkMode?"#222":"#f1f1f1")}function update(){var e=Math.floor(((pointers[0].X-.5*canvasWidth)/view.z+.5*canvasWidth)/cellWidth+view.x),t=Math.floor(((pointers[0].Y-.5*canvasHeight)/view.z+.5*canvasHeight)/cellWidth+view.y),n=GRID.head,r=0,a=0,i=new ListNode(null);if(0===editMode)if(0===GRID.type){for(var l=0;;l++){if(maxDepth<l){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(!(n.distance<=Math.abs(4*e)||n.distance<=Math.abs(4*t)||n.distance<8))break;n=doubleSize(n)}for(var o=0;;o++){if(maxDepth<o){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(2*t<a){if(2*e<r){if(i.value=0,r-=(n=(i.tree=n).child[0]).distance,a-=n.distance,i=new ListNode(i),1===n.distance)break}else if(i.value=1,r+=(n=(i.tree=n).child[1]).distance,a-=n.distance,i=new ListNode(i),1===n.distance)break}else if(2*e<r){if(i.value=2,r-=(n=(i.tree=n).child[2]).distance,a+=n.distance,i=new ListNode(i),1===n.distance)break}else if(i.value=3,r+=(n=(i.tree=n).child[3]).distance,a+=n.distance,i=new ListNode(i),1===n.distance)break}if(null!==n&&(null===n.value&&(n.value=0),-1===drawMode?-1===drawnState&&(isPlaying=0,drawnState=n.value===rule.length-1?0:n.value+1):(-1===drawnState&&(isPlaying=0,drawnState=n.value===drawMode?0:drawMode),isPlaying=0),n.value!==drawnState)){accumulateChanges.value={x:e,y:t,newState:drawnState,oldState:n.value},accumulateChanges=accumulateChanges.child=new ListNode(accumulateChanges),changeCount++;var c=new TreeNode(1);c.value=drawnState;for(var s=0;;s++){if(maxDepth<s){console.log("maxDepth of ".concat(maxDepth," reached."));break}if(c=writeNode(c),null===i.parent){GRID.head=c;break}for(var i=i.parent,d=new TreeNode(i.tree.distance),h=0;h<4;h++)h===i.value?d.child[h]=c:d.child[h]=i.tree.child[h];c=d}document.getElementById("population").innerHTML="Population "+GRID.head.population}}else e>=GRID.finiteArea.left&&e<GRID.finiteArea.right&&t>=GRID.finiteArea.top&&t<GRID.finiteArea.bottom&&(-1===drawMode?-1===drawnState&&(isPlaying=0,drawnState=GRID.finiteArray[e-GRID.finiteArea.left+GRID.finiteArea.margin][t-GRID.finiteArea.top+GRID.finiteArea.margin]===rule.length-1?0:GRID.finiteArray[e-GRID.finiteArea.left+GRID.finiteArea.margin][t-GRID.finiteArea.top+GRID.finiteArea.margin]+1):(-1===drawnState&&(isPlaying=0,drawnState=GRID.finiteArray[e-GRID.finiteArea.left+GRID.finiteArea.margin][t-GRID.finiteArea.top+GRID.finiteArea.margin]===drawMode?0:drawMode),isPlaying=0),gridPopulation+=1===drawnState?1:-1,accumulateChanges.value={x:e,y:t,newState:drawnState,oldState:GRID.finiteArray[e-GRID.finiteArea.left+GRID.finiteArea.margin][t-GRID.finiteArea.top+GRID.finiteArea.margin]},accumulateChanges=accumulateChanges.child=new ListNode(accumulateChanges),changeCount++,GRID.finiteArray[e-GRID.finiteArea.left+GRID.finiteArea.margin][t-GRID.finiteArea.top+GRID.finiteArea.margin]=drawnState);else if(1===editMode)if(2<=pointers.length){var p=distance(pointers[0].dragX-pointers[1].dragX,pointers[0].dragY-pointers[1].dragY);zoom(distance(pointers[0].X-pointers[1].X,pointers[0].Y-pointers[1].Y)/p,.5*(pointers[0].dragX+pointers[1].dragX),.5*(pointers[0].dragY+pointers[1].dragY),view.touchX,view.touchY,view.touchZ)}else switch(edgeBeingDragged){case 0:pasteArea.isActive&&clipboard[activeClipboard]&&e>=pasteArea.left&&e<pasteArea.left+clipboard[activeClipboard].pattern.length&&t>=pasteArea.top&&t<pasteArea.top+clipboard[activeClipboard].pattern[0].length?(edgeBeingDragged=5,pasteArea.pointerRelativeX=e-pasteArea.left,pasteArea.pointerRelativeY=t-pasteArea.top):0!==GRID.type&&e>=GRID.finiteArea.left-1-Math.max(0,4/view.z+GRID.finiteArea.left-GRID.finiteArea.right)&&e<GRID.finiteArea.right+1+Math.max(0,4/view.z+GRID.finiteArea.left-GRID.finiteArea.right)&&t>=GRID.finiteArea.top-1-Math.max(0,4/view.z+GRID.finiteArea.top-GRID.finiteArea.bottom)&&t<GRID.finiteArea.bottom+1+Math.max(0,4/view.z+GRID.finiteArea.top-GRID.finiteArea.bottom)?(e<Math.min(GRID.finiteArea.left+4/view.z,(GRID.finiteArea.right+GRID.finiteArea.left)/2)?(edgeBeingDragged=3,isPlaying=0):e>Math.max(GRID.finiteArea.right-4/view.z,(GRID.finiteArea.right+GRID.finiteArea.left)/2)&&(edgeBeingDragged=1,isPlaying=0),t<Math.min(GRID.finiteArea.top+4/view.z,(GRID.finiteArea.bottom+GRID.finiteArea.top)/2)?(edgeBeingDragged=4,isPlaying=0):t>Math.max(GRID.finiteArea.bottom-4/view.z,(GRID.finiteArea.bottom+GRID.finiteArea.top)/2)&&(edgeBeingDragged=2,isPlaying=0)):(view.x=view.touchX+pointers[0].deltaX/cellWidth/view.z,view.y=view.touchY+pointers[0].deltaY/cellWidth/view.z,socket&&null===resetEvent&&socket.emit("pan",{id:clientId,xPosition:view.x,yPosition:view.y}));break;case 3:e<GRID.finiteArea.right?(GRID.finiteArea.newLeft=e,GRID.finiteArea.newRight=GRID.finiteArea.right):(GRID.finiteArea.newLeft=GRID.finiteArea.right,GRID.finiteArea.newRight=e+1);break;case 1:e<GRID.finiteArea.left?(GRID.finiteArea.newLeft=e,GRID.finiteArea.newRight=GRID.finiteArea.left):(GRID.finiteArea.newLeft=GRID.finiteArea.left,GRID.finiteArea.newRight=e+1);break;case 2:t<GRID.finiteArea.top?(GRID.finiteArea.newTop=t,GRID.finiteArea.newBottom=GRID.finiteArea.top):(GRID.finiteArea.newTop=GRID.finiteArea.top,GRID.finiteArea.newBottom=t+1);break;case 4:t<GRID.finiteArea.bottom?(GRID.finiteArea.newTop=t,GRID.finiteArea.newBottom=GRID.finiteArea.bottom):(GRID.finiteArea.newTop=GRID.finiteArea.bottom,GRID.finiteArea.newBottom=t+1);break;case 5:pasteArea.left=e-pasteArea.pointerRelativeX,pasteArea.top=t-pasteArea.pointerRelativeY}else if(2===editMode)if(!0===selectArea.isActive&&0===edgeBeingDragged&&e>=selectArea.left-1-Math.max(0,4/view.z+selectArea.left-selectArea.right)&&e<selectArea.right+1+Math.max(0,4/view.z+selectArea.left-selectArea.right)&&t>=selectArea.top-1-Math.max(0,4/view.z+selectArea.top-selectArea.bottom)&&t<selectArea.bottom+1+Math.max(0,4/view.z+selectArea.top-selectArea.bottom)){e<Math.min(selectArea.left+4/view.z,(selectArea.right+selectArea.left)/2)?(edgeBeingDragged=-3,isPlaying=0):e>Math.max(selectArea.right-4/view.z,(selectArea.right+selectArea.left)/2)&&(edgeBeingDragged=3,isPlaying=0),t<Math.min(selectArea.top+4/view.z,(selectArea.bottom+selectArea.top)/2)?(edgeBeingDragged+=1,isPlaying=0):t>Math.max(selectArea.bottom-4/view.z,(selectArea.bottom+selectArea.top)/2)&&(--edgeBeingDragged,isPlaying=0);for(var u=0;u<markers.length;u++)2===markers[u].activeState&&(markers[u].activeState=1)}else if(!0===selectArea.isActive&0!==edgeBeingDragged)2===mod(edgeBeingDragged,3)&&(selectArea.bottom=t+1,t<selectArea.top&&(selectArea.bottom=selectArea.top+1,edgeBeingDragged+=2),-1===edgeBeingDragged)&&(e<selectArea.left&&(edgeBeingDragged=-4),e>selectArea.right)&&(edgeBeingDragged=2),2<=(edgeBeingDragged=1===mod(edgeBeingDragged=-4<=edgeBeingDragged&&edgeBeingDragged<=-2&&((selectArea.left=e)>=selectArea.right-1&&(selectArea.left=selectArea.right-1,edgeBeingDragged+=6),-3===edgeBeingDragged)&&(t<selectArea.top&&(edgeBeingDragged=-2),t>selectArea.bottom)?-4:edgeBeingDragged,3)&&((selectArea.top=t)>=selectArea.bottom-1&&(selectArea.top=selectArea.bottom-1,edgeBeingDragged-=2),1===edgeBeingDragged)&&(e<selectArea.left&&(edgeBeingDragged=-2),e>selectArea.right)?4:edgeBeingDragged)&&edgeBeingDragged<=4&&(selectArea.right=e+1,e<selectArea.left+1&&(selectArea.right=selectArea.left+1,edgeBeingDragged-=6),3===edgeBeingDragged)&&(t<selectArea.top&&(edgeBeingDragged=4),t>selectArea.bottom)&&(edgeBeingDragged=2);else{if(-1===selectedMarker)for(var f=0;f<markers.length;f++)if(2===markers[f].activeState){if(markers[f].activeState=1,0<=selectedMarker&&(markers[selectedMarker].activeState=2),-1!==selectedMarker){selectedMarker=-2;break}}else 1===markers[f].activeState&&e>=markers[f].left&&e<markers[f].right&&t>=markers[f].top&&t<markers[f].bottom&&(selectedMarker=f);-1!==selectedMarker?(0<=selectedMarker&&(markers[selectedMarker].activeState=2),console.log("".concat(markers[0].activeState," ").concat(markers[1].activeState," ").concat(markers[2].activeState," ").concat(markers[3].activeState)),setActionMenu()):!1===selectArea.isActive&&(selectArea.isActive=!0,setActionMenu(),edgeBeingDragged=0,selectArea.left=e,selectArea.top=t,selectArea.right=e+1,selectArea.bottom=t+1)}}function getEmptyNode(e){var t;return emptyNodes[GRID.backgroundState]&&emptyNodes[GRID.backgroundState].distance===e?emptyNodes[GRID.backgroundState]:((t=new TreeNode(e)).value=GRID.backgroundState,1!==e&&(t.child[0]=getEmptyNode(e>>>1),t.child[1]=t.child[0],t.child[2]=t.child[1],t.child[3]=t.child[2]),writeNode(t))}function gen(e){genCount++;var t=0===e.backgroundState&&1===rule[0][0][0][0][0][0][0][0][0]?1:1===e.backgroundState?rule[1][1][1][1][1][1][1][1][1]:e.backgroundState===rule.length-1?0:1<e.backgroundState?e.backgroundState+1:e.backgroundState,n=!1;if(0===e.type){for(var r=0;r<4;r++){for(var a=0;a<4;a++)if(r!==3-a&&e.head.child[r].result.child[a].value!==t){n=!0;break}if(!0===n)break}(c=new TreeNode(e.head.distance>>>1)).child[0]=e.head.child[0].child[1],c.child[1]=e.head.child[1].child[0],c.child[2]=e.head.child[0].child[3],c.child[3]=e.head.child[1].child[2],c.value=getValue(c),(c=writeNode(c)).result.child[0].value!==t&&(n=!0),c.result.child[1].value!==t&&(n=!0),(c=new TreeNode(e.head.distance>>>1)).child[0]=e.head.child[1].child[2],c.child[1]=e.head.child[1].child[3],c.child[2]=e.head.child[3].child[0],c.child[3]=e.head.child[3].child[1],c.value=getValue(c),(c=writeNode(c)).result.child[1].value!==t&&(n=!0),c.result.child[3].value!==t&&(n=!0),(c=new TreeNode(e.head.distance>>>1)).child[0]=e.head.child[2].child[1],c.child[1]=e.head.child[3].child[0],c.child[2]=e.head.child[2].child[3],c.child[3]=e.head.child[3].child[2],c.value=getValue(c),(c=writeNode(c)).result.child[3].value!==t&&(n=!0),c.result.child[2].value!==t&&(n=!0),(c=new TreeNode(e.head.distance>>>1)).child[0]=e.head.child[0].child[2],c.child[1]=e.head.child[0].child[3],c.child[2]=e.head.child[2].child[0],c.child[3]=e.head.child[2].child[1],c.value=getValue(c),(c=writeNode(c)).result.child[2].value!==t&&(n=!0),!0===(n=c.result.child[0].value!==t||n)&&(e.head=doubleSize(e.head)),e.backgroundState=t;var i=new TreeNode(e.head.distance);emptyNodes[e.backgroundState]||(emptyNodes[e.backgroundState]=getEmptyNode(e.head.distance>>2));for(var l=0;l<4;l++){i.child[l]=new TreeNode(e.head.distance>>>1);for(var o=0;o<4;o++)i.child[l].child[o]=l===3-o?e.head.result.child[l]:emptyNodes[e.backgroundState];i.child[l].value=getValue(i.child[l]),i.child[l]=writeNode(i.child[l])}i.value=getValue(i),e.head=writeNode(i)}else if(0<e.type){for(var c=1===e.type?1:0,s=iteratePattern(e.finiteArray,c,e.finiteArray.length-c,e.finiteArray[0].length-c,c),d=gridPopulation=0;d<e.finiteArray.length;d++)for(var h=0;h<e.finiteArray[0].length;h++)h>=e.finiteArea.margin&&d<e.finiteArray.length-e.finiteArea.margin&&h<e.finiteArray[0].length-e.finiteArea.margin&&d>=e.finiteArea.margin?e.finiteArray[d][h]=s[d-e.finiteArea.margin][h-e.finiteArea.margin]:e.finiteArray[d][h]=t,e.finiteArray[d][h]!==t&&gridPopulation++;e.backgroundState=t}}function getScreenXPosition(e){return.5*canvasWidth-((view.x-e)*cellWidth+.5*canvasWidth)*view.z}function getScreenYPosition(e){return.5*canvasHeight-((view.y-e)*cellWidth+.5*canvasHeight)*view.z}function drawSquare(e,t,n){var r=[-1,1,-1,1],a=[-1,-1,1,1];if(!(getScreenXPosition((t-e.distance)/2)>canvasWidth||getScreenYPosition((n+e.distance)/2)<0||getScreenXPosition((t+e.distance)/2)<0||getScreenYPosition((n-e.distance)/2)>canvasHeight)){if(null===e.value)for(var i=0;i<4;i++)e.value!==(document.getElementById("antiStrobing").checked?GRID.backgroundState:0)&&null!==e.child[i]&&(drawSquare(e.child[i],t+e.child[i].distance*r[i],n+e.child[i].distance*a[i]),!0===isElementCheckedById("debugVisuals"))&&null===e.value&&(ctx.strokeStyle="rgba(240,240,240,0.7)",ctx.beginPath(),ctx.moveTo(getScreenXPosition(t/2),getScreenYPosition(n/2),view.z*cellWidth,view.z*cellWidth),ctx.lineTo(getScreenXPosition((t+r[i]*e.child[i].distance)/2),getScreenYPosition((n+a[i]*e.child[i].distance)/2),view.z*cellWidth,view.z*cellWidth),ctx.lineWidth=view.z,ctx.stroke());else e.value!==(document.getElementById("antiStrobing").checked?GRID.backgroundState:0)&&(ctx.fillStyle=getColor(e.value),ctx.fillRect(getScreenXPosition((t-e.distance)/2),getScreenYPosition((n-e.distance)/2),view.z*cellWidth*e.distance,view.z*cellWidth*e.distance));!0===isElementCheckedById("debugVisuals")&&e.distance<2048&&(null===e.depth?ctx.strokeStyle="#FF0000":ctx.strokeStyle="#".concat(Math.floor(Math.abs(16777215*Math.sin(3+5*e.depth+7*e.key%hashTable.length))).toString(16)),ctx.lineWidth=4*view.z/e.distance.toString(2).length,ctx.strokeRect(.5*canvasWidth-((view.x-.5*(t-e.distance))*cellWidth+.5*canvasWidth-2/e.distance)*view.z,.5*canvasHeight-((view.y-.5*(n-e.distance))*cellWidth+.5*canvasHeight-2/e.distance)*view.z,(e.distance*cellWidth-4/e.distance)*view.z,(e.distance*cellWidth-4/e.distance)*view.z))}}function render(){var e=view.x%1,t=view.y%1,n=cellWidth*view.z;if(ctx.clearRect(0,0,canvasWidth,canvasHeight),ctx.fillStyle=darkMode?"#fff":"#000",ctx.font="20px Arial",!0===isElementCheckedById("debugVisuals")){ctx.fillText("view: ".concat(Math.round(view.x)," ").concat(Math.round(view.touchX)," ").concat(Math.round(view.y)," ").concat(Math.round(view.touchY)),10,15),ctx.fillText("".concat(numberOfNodes," hashnodes"),10,30),ctx.fillText("".concat(depthTotal/depthCount," hashnode depth"),10,45),ctx.fillText("".concat(ruleMetadata.size," rule nodes depth"),10,60);for(var r=0;r<pointers.length;r++)ctx.fillText("cursor position: ".concat(pointers[r].X," ").concat(pointers[r].Y),10,75+15*r);for(var a=1;a<hashTableDepths.length;a++)hashTableDepths[a]&&hashTableDepths[a]&&ctx.fillRect(10*a,40,10,2*hashTableDepths[a].toString(2).length)}if(!0===selectArea.isActive&&(ctx.fillStyle=2===editMode&&0!==edgeBeingDragged?darkMode?"#333":"#999":darkMode?"#292929":"#ccc",ctx.fillRect(.5*canvasWidth-((view.x-selectArea.left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-selectArea.top)*cellWidth+.5*canvasHeight)*view.z,(selectArea.right-selectArea.left)*n-1,(selectArea.bottom-selectArea.top)*n-1)),pasteArea.isActive&&clipboard[activeClipboard].pattern[0]&&(ctx.fillStyle=2===editMode&&0!==edgeBeingDragged?darkMode?"#555":"#999":darkMode?"#333":"#ccc",ctx.fillRect(.5*canvasWidth-((view.x-pasteArea.left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-pasteArea.top)*cellWidth+.5*canvasHeight)*view.z,clipboard[activeClipboard].pattern.length*n-1,clipboard[activeClipboard].pattern[0].length*n-1)),0===GRID.type)drawSquare(GRID.head,0,0);else for(var i=0;i<GRID.finiteArray.length-2*GRID.finiteArea.margin;i++)for(var l=0;l<GRID.finiteArray[0].length-2*GRID.finiteArea.margin;l++)GRID.backgroundState!==GRID.finiteArray[i+GRID.finiteArea.margin][l+GRID.finiteArea.margin]&&(ctx.fillStyle=getColor(GRID.finiteArray[i+GRID.finiteArea.margin][l+GRID.finiteArea.margin]),ctx.fillRect(.5*canvasWidth-((view.x-(GRID.finiteArea.left+i))*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-(GRID.finiteArea.top+l))*cellWidth+.5*canvasHeight)*view.z,view.z*cellWidth,view.z*cellWidth));if(ctx.globalAlpha=.8,pasteArea.isActive&&clipboard[activeClipboard]&&clipboard[activeClipboard].pattern.length)for(var o=0;o<clipboard[activeClipboard].pattern.length;o++)for(var c=0;c<clipboard[activeClipboard].pattern[0].length;c++)0<clipboard[activeClipboard].pattern[o][c]&&(ctx.fillStyle=getColor(clipboard[activeClipboard].pattern[o][c]),ctx.fillRect(.5*canvasWidth-(.5*canvasWidth+view.x*cellWidth)*view.z+(pasteArea.left+o)*n,.5*canvasHeight-(.5*canvasHeight+view.y*cellWidth)*view.z+(pasteArea.top+c)*n,n,n));for(var s=0;s<markers.length;s++)if(markers[s].pattern&&0!==markers[s].activeState)for(var d=0;d<markers[s].pattern.length;d++)for(var h=0;h<markers[s].pattern[0].length;h++)0<markers[s].pattern[d][h]&&(ctx.fillStyle=getColor(markers[s].pattern[d][h]),ctx.fillRect(.5*canvasWidth-(.5*canvasWidth+view.x*cellWidth)*view.z+(markers[s].left+d)*n,.5*canvasHeight-(.5*canvasHeight+view.y*cellWidth)*view.z+(markers[s].top+h)*n,n,n));if(ctx.globalAlpha=1,!0===isElementCheckedById("gridLines")&&(ctx.strokeStyle=darkMode?"#999":"#000000",!0===detailedCanvas)){ctx.lineWidth=.5*view.z,ctx.beginPath();for(var p=-Math.ceil(.5*canvasWidth/n);p<.5*canvasWidth/n+1;p++)ctx.moveTo(.5*canvasWidth+(p-e)*n,0),ctx.lineTo(.5*canvasWidth+(p-e)*n,canvasHeight);for(var u=-Math.ceil(.5*canvasHeight/n);u<.5*canvasHeight/n+1;u++)ctx.moveTo(0,.5*canvasHeight+(u-t)*n),ctx.lineTo(canvasWidth,.5*canvasHeight+(u-t)*n);ctx.stroke()}for(var f,g=0;g<2;g++)for(var v=0;v<markers.length;v++)0!==markers[v].activeState&&(1===markers[v].activeState?ctx.strokeStyle=darkMode?"#888":"#999":2===markers[v].activeState&&(darkMode?(ctx.strokeStyle="#bbb",ctx.fillStyle="#bbb"):(ctx.strokeStyle="#999",ctx.fillStyle="#999"),ctx.lineWidth=1,ctx.fillText(v+1,.5*canvasWidth+ +view.z-((view.x-markers[v].left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-6*view.z-((view.y-markers[v].top)*cellWidth+.5*canvasHeight)*view.z,(markers[v].right-markers[v].left)*n-1)),ctx.lineWidth=5*view.z,0===g&&1===markers[v].activeState||1===g&&2===markers[v].activeState)&&ctx.strokeRect(.5*canvasWidth-((view.x-markers[v].left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-markers[v].top)*cellWidth+.5*canvasHeight)*view.z,(markers[v].right-markers[v].left)*n-1,(markers[v].bottom-markers[v].top)*n-1);for(f in!0===selectArea.isActive&&(ctx.lineWidth=3*view.z,ctx.strokeStyle="#666",ctx.strokeRect(.5*canvasWidth-((view.x-selectArea.left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-selectArea.top)*cellWidth+.5*canvasHeight)*view.z,(selectArea.right-selectArea.left)*n-1,(selectArea.bottom-selectArea.top)*n-1)),pasteArea.isActive&&clipboard[activeClipboard].pattern[0]&&(ctx.lineWidth=3*view.z,ctx.strokeStyle="#666",ctx.strokeRect(.5*canvasWidth-((view.x-pasteArea.left)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-pasteArea.top)*cellWidth+.5*canvasHeight)*view.z,clipboard[activeClipboard].pattern.length*n-1,clipboard[activeClipboard].pattern[0].length*n-1)),0!==GRID.type&&(ctx.lineWidth=8*view.z,ctx.strokeStyle=darkMode?"#888":"#999",ctx.strokeRect(.5*canvasWidth-((view.x-GRID.finiteArea.newLeft)*cellWidth+.5*canvasWidth)*view.z,.5*canvasHeight-((view.y-GRID.finiteArea.newTop)*cellWidth+.5*canvasHeight)*view.z,(GRID.finiteArea.newRight-GRID.finiteArea.newLeft)*n-1,(GRID.finiteArea.newBottom-GRID.finiteArea.newTop)*n-1)),clientList)ctx.strokeStyle="hsla(".concat(clientList[f].color[0],",100%,80%,1)"),ctx.lineWidth=4,ctx.strokeRect(.5*canvasWidth-(view.x-clientList[f].xPosition+15/clientList[f].zoom)*cellWidth*view.z,.5*canvasHeight-(view.y-clientList[f].yPosition+10/clientList[f].zoom)*cellWidth*view.z,canvasWidth*view.z/clientList[f].zoom,canvasHeight*view.z/clientList[f].zoom),ctx.fillStyle=ctx.strokeStyle,ctx.font="30px Arial",ctx.fillText(f,.5*canvasWidth-(view.x-clientList[f].xPosition+15/clientList[f].zoom)*cellWidth*view.z,180-(view.y-clientList[f].yPosition+10/clientList[f].zoom)*cellWidth*view.z)}function scaleCanvas(){windowWidth=window.innerWidth||document.documentElement.clientWidth,windowHeight=window.innerHeight||document.documentElement.clientHeight,canvasWidth=windowWidth-20<1.2*windowHeight?(canvasHeight=(windowWidth-20)/1.5,windowWidth-20):(canvasHeight=.8*windowHeight,1.2*windowHeight),document.getElementById("top").style.width=300<windowWidth-canvasWidth?"".concat(windowWidth-canvasWidth-30,"px"):"auto",canvas.width=canvasWidth,canvas.height=canvasHeight,cellWidth=canvasHeight/40}function readRLE(e){for(var t=0,n=0,r=["x","=",",","y","=",","],a=[],i=-1,l=-1,o=0;;o++){if(o>=e.length)return console.log("RLE not found"),-1;if("#"===e[o]&&(0===o||"\n"===e[o-1]))for(;"\n"!==e[o]&&o<e.length;)o++,n++;if(isNaN(e[o])?e[o]===r[t]?(t++,0!==a.length&&(-1===i?i=parseInt(a.join(""),10):l=parseInt(a.join(""),10),a=[])):(l=i=-1,o=++n,t=0):" "!==e[o]&&1<t&&a.push(e[o]),6===t){n=o;break}}var c=[];if("r"===e[n+1]||"r"===e[n+2]){for(var c=[],s=n;s<e.length;s++){if("\n"===e[s]||":"===e[s]){n=s;break}if(-1===n)if(" "===e[s]){if(0<c.length){n=s;break}}else c.push(e[s]);"="===e[s]&&(n=-1)}rulestring!==c.join("")&&(document.getElementById("rule").value=c.join(""),setRule(c.join("")),socket)&&socket.emit("rule",rulestring)}else"B3/S23"!==rulestring&&(parseRulestring(document.getElementById("rule").value="B3/S23"),resetHashtable());if(":"===e[n]){if("P"===e[n+1])GRID.type=1;else{if("T"!==e[n+1])throw new Error("unsupported finite grid type");GRID.type=2}if(c=[],"0"===e[n+2])i+=50,n+=4;else for(var d=n+2;d<e.length;d++){if(isNaN(e[d])){i=parseInt(c.join("")),c=[],n=d+1;break}c.push(e[d])}if("0"===e[n])l+=50,n++;else for(var h=n;h<e.length;h++){if(isNaN(e[h])||"\n"===e[h]){l=parseInt(c.join("")),c=[],n=h-1;break}c.push(e[h])}}else GRID.type=0;var p=rleToPattern(e.slice(-(e.length-++n)),i,l);if(2===rule.length)for(var u=0;u<p.length;u++)for(var f=0;f<p[u].length;f++)p[u][f]=p[u][f]%2==1?1:0;return p}function rleToPattern(e,t,n){for(var r=0,a=1,i=0,l=0,o=new Array(t),c=[],s=0;s<o.length;s++)o[s]=new Array(n),o[s].fill(0);for(;r<e.length;){for(var d=0;d<a;d++)void 0===o[i+d]&&(o[i+d]=new Array(n),o[i+d].fill(0));if("b"===e[r]||"."===e[r])i+=a,r++,a=1;else if("o"===e[r]){for(var h=0;h<a;h++)o[i][l]=1,i++;r++,a=1}else if(65<=e[r].charCodeAt(0)&&e[r].charCodeAt(0)<=91){for(var p=0;p<a;p++)o[i][l]=e[r].charCodeAt(0)-64,i++;r++,a=1}else if(isNaN(e[r])||"\n"===e[r])if("$"===e[r])i=0,l+=a,r++,a=1;else{if("!"===e[r])break;r++}else{for(var c=[],u=0;u<70&&!isNaN(e[r]);u++)c.push(e[r]),r++;a=parseInt(c.join(""),10)}}for(var f=0;f<o.length;f++)for(var g=0;g<=l;g++)o[f][g]||(o[f][g]=0);return o}function exportPattern(){var e;switch(GRID.type){case 0:return{xOffset:(null!=(e=getLeftBorder(GRID.head))?e:0)/2-.5,yOffset:(null!=(e=getTopBorder(GRID.head))?e:0)/2-.5,pattern:readPattern((null!=(e=getTopBorder(GRID.head))?e:0)/2-.5,(null!=(e=getRightBorder(GRID.head))?e:0)/2+.5,(null!=(e=getBottomBorder(GRID.head))?e:0)/2+.5,(null!=(e=getLeftBorder(GRID.head))?e:0)/2-.5)};case 1:for(var t=new Array(GRID.finiteArray.length-2),n=0;n<t.length;n++){t[n]=new Array(GRID.finiteArray[0].length-2);for(var r=0;r<t[0].length;r++)n<GRID.finiteArray.length-1&&r<GRID.finiteArray[0].length-1?t[n][r]=GRID.finiteArray[n+1][r+1]:t[n][r]=GRID.backgroundState}return{xOffset:GRID.finiteArea.left,yOffset:GRID.finiteArea.top,pattern:t};case 2:return{xOffset:GRID.finiteArea.left,yOffset:GRID.finiteArea.top,pattern:GRID.finiteArray};default:throw new Error("exporting unknown grid type")}}function importPattern(e,t,n){switch(GRID.type){case 0:GRID.head=getEmptyNode(8),GRID.head=widenTree({top:n,right:t+e.length,bottom:n+e[0].length,left:t}),GRID.head=writePatternToGrid(t,n,e,GRID.head);break;case 1:GRID.finiteArea.margin=1,GRID.finiteArea.top=n,GRID.finiteArea.right=e.length+t,GRID.finiteArea.bottom=e[0].length+n,GRID.finiteArea.left=t,GRID.finiteArray=new Array(e.length+2);for(var r=0;r<GRID.finiteArray.length;r++){GRID.finiteArray[r]=new Array(e[0].length+2);for(var a=0;a<GRID.finiteArray[0].length;a++)1<=r&&r<e.length+1&&1<=a&&a<e[0].length+1?GRID.finiteArray[r][a]=e[r-1][a-1]:GRID.finiteArray[r][a]=GRID.backgroundState}break;case 2:GRID.finiteArea.margin=0,GRID.finiteArea.top=n,GRID.finiteArea.right=e.length+t,GRID.finiteArea.bottom=e[0].length+n,GRID.finiteArea.left=t,GRID.finiteArray=e;break;default:throw new Error("importing unknown grid type")}GRID.finiteArea.newTop=GRID.finiteArea.top,GRID.finiteArea.newRight=GRID.finiteArea.right,GRID.finiteArea.newBottom=GRID.finiteArea.bottom,GRID.finiteArea.newLeft=GRID.finiteArea.left}function resetClipboard(){pasteArea.isActive=!1,0===activeClipboard&&(activeClipboard=parseInt(document.getElementById("copyMenu").previousElementSibling.innerText))}function uncheckSiblings(t){_toConsumableArray(t.parentElement.children).forEach(function(e){e!==t&&(e.checked=!1)})}function importRLE(e){if(0===(e=e.split("")).length)return console.log("RLE box empty"),-1;var t=readRLE(e);if(-1===t)return-1;if(e&&t)if(0===GRID.head.value){for(var n=new Array(t.length),r=0;r<n.length;r++)n[r]=new Array(t[0].length).fill(0);importPattern(t,-Math.ceil(t.length/2),-Math.ceil(t[0].length/2)),socket&&socket.emit("paste",Date.now(),{newPatt:[-Math.ceil(t.length/2),-Math.ceil(t[0].length/2),t],oldPatt:[-Math.ceil(t.length/2),-Math.ceil(t[0].length/2),n]}),fitView()}else clipboard[activeClipboard=0].pattern=t,editMode=1,pasteArea.isActive=!0,pasteArea.left=-Math.ceil(t.length/2),pasteArea.top=-Math.ceil(t[0].length/2),setActionMenu();render(),currentEvent=new EventNode(currentEvent,"import RLE")}function exportRLE(){return patternToRLE(exportPattern().pattern)}function clearRLE(){document.getElementById("rle").value=""}function copyRLE(){document.getElementById("rle").select(),document.getElementById("rle").setSelectionRange(0,99999),document.execCommand("copy")}function resetHashtable(){reset(),currentEvent.child=null,hashTable=new Array(hashTable.length),GRID.head.result=recalculateResult(GRID.head)}function recalculateResult(e){if(4<e.distance)for(var t=0;t<4;t++)e.child[t].result=recalculateResult(e.child[t]);return getResult(e)}function setRule(e){parseRulestring({Life:"B3/S23",LifeHistory:"B3/S23History",HighLife:"B36/S23",HighLifeHistory:"B36/S23History"}[rulestring=e]||rulestring),resetHashtable()}function generateTree(e,t,n,r){for(var a=new Array(n),i=0;i<n;i++)ruleMetadata.size++,8===t?a[i]=getTransition([].concat(_toConsumableArray(e),[i]),n,r):"Generations"===ruleMetadata.family&&2<i?a[i]=a[0]:"History"===ruleMetadata.family&&1<i&&!1===ruleMetadata.forceDeath[i]&&3!==i?a[i]=a[i-2]:a[i]=generateTree([].concat(_toConsumableArray(e),[i]),t+1,n,r);return a}function getTransition(e,t,n){var r=[[0,"-"],[1,"c"],[1,"c"],[2,"c"],[1,"c"],[2,"n"],[2,"c"],[3,"c"],[1,"c"],[2,"c"],[2,"n"],[3,"c"],[2,"c"],[3,"c"],[3,"c"],[4,"c"],[1,"e"],[2,"a"],[2,"a"],[3,"i"],[2,"k"],[3,"q"],[3,"n"],[4,"n"],[2,"k"],[3,"n"],[3,"q"],[4,"n"],[3,"y"],[4,"y"],[4,"y"],[5,"e"],[1,"e"],[2,"k"],[2,"a"],[3,"n"],[2,"a"],[3,"q"],[3,"i"],[4,"n"],[2,"k"],[3,"y"],[3,"q"],[4,"y"],[3,"n"],[4,"y"],[4,"n"],[5,"e"],[2,"e"],[3,"j"],[3,"a"],[4,"a"],[3,"j"],[4,"w"],[4,"a"],[5,"a"],[3,"k"],[4,"k"],[4,"q"],[5,"j"],[4,"k"],[5,"k"],[5,"j"],[6,"e"],[1,"e"],[2,"a"],[2,"k"],[3,"n"],[2,"k"],[3,"q"],[3,"y"],[4,"y"],[2,"a"],[3,"i"],[3,"q"],[4,"n"],[3,"n"],[4,"n"],[4,"y"],[5,"e"],[2,"e"],[3,"a"],[3,"j"],[4,"a"],[3,"k"],[4,"q"],[4,"k"],[5,"j"],[3,"j"],[4,"a"],[4,"w"],[5,"a"],[4,"k"],[5,"j"],[5,"k"],[6,"e"],[2,"i"],[3,"r"],[3,"r"],[4,"i"],[3,"r"],[4,"z"],[4,"t"],[5,"r"],[3,"r"],[4,"t"],[4,"z"],[5,"r"],[4,"i"],[5,"r"],[5,"r"],[6,"i"],[3,"e"],[4,"r"],[4,"r"],[5,"i"],[4,"j"],[5,"q"],[5,"n"],[6,"a"],[4,"j"],[5,"n"],[5,"q"],[6,"a"],[5,"y"],[6,"k"],[6,"k"],[7,"e"],[1,"e"],[2,"k"],[2,"k"],[3,"y"],[2,"a"],[3,"q"],[3,"n"],[4,"y"],[2,"a"],[3,"n"],[3,"q"],[4,"y"],[3,"i"],[4,"n"],[4,"n"],[5,"e"],[2,"i"],[3,"r"],[3,"r"],[4,"t"],[3,"r"],[4,"z"],[4,"i"],[5,"r"],[3,"r"],[4,"i"],[4,"z"],[5,"r"],[4,"t"],[5,"r"],[5,"r"],[6,"i"],[2,"e"],[3,"k"],[3,"j"],[4,"k"],[3,"a"],[4,"q"],[4,"a"],[5,"j"],[3,"j"],[4,"k"],[4,"w"],[5,"k"],[4,"a"],[5,"j"],[5,"a"],[6,"e"],[3,"e"],[4,"j"],[4,"r"],[5,"n"],[4,"r"],[5,"q"],[5,"i"],[6,"a"],[4,"j"],[5,"y"],[5,"q"],[6,"k"],[5,"n"],[6,"k"],[6,"a"],[7,"e"],[2,"e"],[3,"j"],[3,"k"],[4,"k"],[3,"j"],[4,"w"],[4,"k"],[5,"k"],[3,"a"],[4,"a"],[4,"q"],[5,"j"],[4,"a"],[5,"a"],[5,"j"],[6,"e"],[3,"e"],[4,"r"],[4,"j"],[5,"n"],[4,"j"],[5,"q"],[5,"y"],[6,"k"],[4,"r"],[5,"i"],[5,"q"],[6,"a"],[5,"n"],[6,"a"],[6,"k"],[7,"e"],[3,"e"],[4,"j"],[4,"j"],[5,"y"],[4,"r"],[5,"q"],[5,"n"],[6,"k"],[4,"r"],[5,"n"],[5,"q"],[6,"k"],[5,"i"],[6,"a"],[6,"a"],[7,"e"],[4,"e"],[5,"c"],[5,"c"],[6,"c"],[5,"c"],[6,"n"],[6,"c"],[7,"c"],[5,"c"],[6,"c"],[6,"n"],[7,"c"],[6,"c"],[7,"c"],[7,"c"],[8,"-"]],a=n,i=0,l=e[8];if("Generations"===ruleMetadata.family&&1<l)return(l+1)%t;for(var o=0;o<e.length-1;o++)if(e[o]%2==1&&(i+=Math.pow(2,o)),ruleMetadata.forceDeath[e[o]]&&l%2==1)return ruleMetadata.deadState[l];if(-1===(n=a[l%2].indexOf("".concat(r[i][0]))))return ruleMetadata.deadState[l];var c=!0;"aceijknqrtwyz".includes(a[l%2][n+1])&&(c=!1);for(var s=n+1;s<a[l%2].length&&isNaN(a[l%2][s]);s++)if(a[l%2][s]===r[i][1]){c^=!0;break}return(c?ruleMetadata.aliveState:ruleMetadata.deadState)[l]}function parseRulestring(e){var t=(e=clean(e=e||"B3/S23")).split("/").map(function(e){return e.split("")}),t=(console.log(t),2);3===e.split("/").length&&(t=parseInt(e.split("/")[2].slice(1))),/.+(History)$/g.test(rulestring)?(ruleMetadata={size:0,family:"History",color:["#303030","#00FF00","#0000A0","#FFD8FF","#FF0000","#FFFF00","#606060"],aliveState:[1,1,1,3,3,5,6],deadState:[0,2,2,4,4,4,6],forceDeath:[!1,!1,!1,!1,!1,!1,!0],forceLife:[!1,!1,!1,!1,!1,!1,!1]},t=7):/.+(Super)$/g.test(rulestring)?(ruleMetadata={size:0,family:"Super",color:["#303030","#00FF00","#0000A0","#FFD8FF","#FF0000","#FFFF00","#606060"],aliveState:[1,1,1,3,3,5,6],deadState:[0,2,2,4,4,4,6],forceDeath:[!(ruleMetadata={size:0,family:"Super",color:[]}),!1,!1,!1,!1,!1,!0],forceLife:[!1,!1,!1,!1,!1,!1,!1]},t=20):ruleMetadata=2<t?{size:0,family:"Generations",color:[],aliveState:[1,1],deadState:[0,2],forceDeath:[!1,!1],forceLife:[!1,!1]}:{size:0,family:"INT",color:[],aliveState:[1,1],deadState:[0,0],forceDeath:[!1,!1],forceLife:[!1,!1]},ruleMetadata.color[0]&&(canvas.style.backgroundColor=ruleMetadata.color[0]),rule=generateTree([],0,t,e.replace(/(Super)|(History)$/g,"").split("/").map(function(e){return e.split("")})),setDrawMenu()}function clean(e){if(console.log(e),["Life","LifeHistory","HighLife","HighLifeHistory"].includes(e))return e;if(/:/g.test(e))return alert("Unsupported Character In Rule"),e;if(!/^[BSGbsg\/\-012345678aceijknqrtwyz]+(History)?$/g.test(e))return alert("Unsupported Character In Rule"),e;var r=[["-"],["-","c","e"],["-","a","c","e","i","k","n"],["-","a","c","e","i","j","k","n","q","r","y"],["-","a","c","e","i","j","k","n","q","r","t","w","y","z"],["-","a","c","e","i","j","k","n","q","r","y"],["-","a","c","e","i","k","n"],["-","c","e"],["-"]],t=e.match(/(History)$/g);1===(n=e.replace(/(History)$/g,"").replace(/[bsg]/g,function(e){return e.toUpperCase()}).split(/\/|(?=[BSG])/)).length&&(n[1]="B"===n[0][0]?"S":"B"),/[0123456789]/g.test(n[0][0]+n[1][0])?n=n.map(function(e,t){return"SBG"[t]+e}):n[2]&&"G"!==n[2][0]&&(n[2]="G"+n[2]),console.log(n);for(var n=n.sort(function(e,t){return["B","S","G"].indexOf(e[0])-["B","S","G"].indexOf(t[0])}),a=0;a<n.length||a<2;a++)n[a]=n[a].split(/(?=[0-8])|(?<=\/)/g).map(function(e){var t,n;return/[BSG]/g.test(e)||/4[aceijknqrtwyz]{7}(?=[0-8]|\/|$)/g.test(e)?e.split("").sort().join(""):(t=parseInt(e[0]),n=_toConsumableArray(new Set(e.slice(1).split(""))),t+r[t].filter(function(e){return-1===n.indexOf(e)==n.length>=r[t].length/2}).join(""))}),n[a]=n[a].join("").replace(/-(?=[0-8]|\/|$)/g,"");return n.join("/")+(null!=t?t:"")}scaleCanvas(),setActionMenu(),updateDropdownMenu(),setDrawMenu(),save(),""!==location.search&&importSettings(),requestAnimationFrame(main),canvas.onmousedown=function(e){"CANVAS"===e.target.nodeName&&canvas.focus(),edgeBeingDragged=0,inputReset(),pointers.push(new Pointer(e.clientX-canvas.getBoundingClientRect().left,e.clientY-canvas.getBoundingClientRect().top)),!1===isKeyBeingPressed&&0===isPlaying&&(0<pointers.length&&update(),render()),e.preventDefault()},canvas.onmousemove=function(e){0<pointers.length&&(pointers[0].X=e.clientX-canvas.getBoundingClientRect().left,pointers[0].Y=e.clientY-canvas.getBoundingClientRect().top),!1===isKeyBeingPressed&&0===isPlaying&&(0<pointers.length&&update(),render())},window.onmouseup=function(e){edgeBeingDragged=0,inputReset(),pointers.splice(0,1),!1===isKeyBeingPressed&&0===isPlaying&&(0<pointers.length&&update(),render())},window.addEventListener("copy",function(e){/[^input|textarea|select]/i.test(document.activeElement.tagName)&&(e.cancelable&&e.preventDefault(),navigator.clipboard.writeText(exportRLE()).then(function(){console.log("successfully copied")},function(){alert("failed to copy pattern to clipboard")}))}),window.addEventListener("paste",function(e){/[^input|textarea|select]/i.test(document.activeElement.tagName)&&(e.cancelable&&e.preventDefault(),importRLE((e.clipboardData||window.clipboardData).getData("text")))}),window.onkeydown=function(e){if(!1===isKeyBeingPressed&&(timeOfLastUpdate=0),!1===e.ctrlKey&&9!==e.keyCode&&32!==e.keyCode&&(e.keyCode<37||40<e.keyCode)&&"TEXTAREA"!==e.target.nodeName&&("INPUT"!==e.target.nodeName||"text"!=e.target.type)){switch(key[e.keyCode]=!0,0===isPlaying&&!1===isKeyBeingPressed&&requestAnimationFrame(main),isKeyBeingPressed=!0,e.keyCode){case 13:start();break;case 46:deleteMarker();break;case 49:draw();break;case 50:move();break;case 51:select();break;case 67:setTimeout(function(){copy()});break;case 70:fitView();break;case 73:invertGrid();break;case 75:clearGrid();break;case 77:setMark();break;case 78:next();break;case 82:selectArea.isActive?randomizeGrid(selectArea):pasteArea.isActive&&(flipDiag(),key[16]?flipOrtho("vertical"):flipOrtho("horizonal"));break;case 83:key[16]&&selectAll();break;case 84:reset(!0===isElementCheckedById("resetStop")),resetActions();break;case 86:paste(),render();break;case 88:cut();break;case 90:(key[16]?redo:undo)()}e.preventDefault()}},window.onkeyup=function(e){for(var t in key[e.keyCode]=!1,isKeyBeingPressed=!1,key)!0===key[t]&&(isKeyBeingPressed=!0)},window.onresize=function(){0===isPlaying&&(scaleCanvas(),render()),updateDropdownMenu()},window.onscroll=function(){captureScroll=!1,updateDropdownMenu()},canvas.ontouchstart=resetPointers,canvas.ontouchend=resetPointers,canvas.ontouchmove=reloadPointers,canvas.onwheel=function(e){var t,n;!0===captureScroll&&(e.cancelable&&e.preventDefault(),t=e.clientX-canvas.getBoundingClientRect().left,n=e.clientY-canvas.getBoundingClientRect().top,zoom(1-.1*Math.sign(e.deltaY),t,n),!1===isKeyBeingPressed)&&0===isPlaying&&(0<pointers.length&&update(),render())},document.getElementById("density").oninput=function(){document.getElementById("percent").innerText="".concat(this.value,"%")},socket&&socket.on("addConnection",function(e,t){for(var n in console.log(t),void 0===clientList[e]&&(clientList[e]={xPosition:-15,yPosition:-10,zoom:1,color:[Math.ceil(360*Math.random()),Math.ceil(255*Math.random()),Math.ceil(255*Math.random())]}),clientList)-1===t.indexOf(n)&&(console.log("deleted ".concat(n)),delete clientList[n]);render()}),socket&&socket.on("initializeConnection",function(e,t){clientId=e;var n,r=t.slice();for(n in r.splice(t.indexOf(socket.id),1),r)console.log(r[n]),clientList[r[n]]={xPosition:-15,yPosition:-10,zoom:1,color:[Math.ceil(360*Math.random()),Math.ceil(255*Math.random()),Math.ceil(255*Math.random())]},socket.emit("requestPosition",r[n]);0<r.length&&socket.emit("requestGrid",r[Math.floor(Math.random()*r.length)])}),socket&&socket.on("relayRequestPosition",function(){socket.emit("pan",{id:clientId,xPosition:view.x,yPosition:view.y}),socket.emit("zoom",{id:clientId,zoom:view.z})}),socket&&socket.on("relayRequestGrid",function(e){var t;console.log("sending grid"),null===resetEvent?0===GRID.type?(console.log(readPattern(-GRID.head.distance/4,GRID.head.distance/4,GRID.head.distance/4,-GRID.head.distance/4)),socket.emit("sendGrid",{type:GRID.type,finite:GRID.finiteArea,data:[-GRID.head.distance/4,-GRID.head.distance/4,readPattern(-GRID.head.distance/4,GRID.head.distance/4,GRID.head.distance/4,-GRID.head.distance/4)]},e)):socket.emit("sendGrid",{type:GRID.type,finite:GRID.finiteArea,data:GRID.finiteArray},e):0===GRID.type?socket.emit("sendGrid",{type:resetEvent.type,finite:GRID.finiteArea,data:[(null!=(t=getLeftBorder(GRID.head))?t:0)/2-.5,(null!=(t=getTopBorder(GRID.head))?t:0)/2-.5,readPattern((null!=(t=getTopBorder(GRID.head))?t:0)/2-.5,(null!=(t=getRightBorder(GRID.head))?t:0)/2+.5,(null!=(t=getBottomBorder(GRID.head))?t:0)/2+.5,(null!=(t=getLeftBorder(GRID.head))?t:0)/2-.5,resetEvent)]},e):socket.emit("sendGrid",{type:resetEvent.type,finite:GRID.finiteArea,data:resetEvent.finiteArray},e),socket&&socket.emit("rule",rulestring)}),socket&&socket.on("relaySendGrid",function(e){console.log(e),GRID.type=e.type,0!==GRID.type?(GRID.finiteArea.margin=e.finite.margin,GRID.finiteArea.top=e.finite.top,GRID.finiteArea.right=e.finite.right,GRID.finiteArea.bottom=e.finite.bottom,GRID.finiteArea.left=e.finite.left,GRID.finiteArea.newTop=e.finite.top,GRID.finiteArea.newRight=e.finite.right,GRID.finiteArea.newBottom=e.finite.bottom,GRID.finiteArea.newLeft=e.finite.left,GRID.finiteArray=e.data,console.log(GRID.finiteArray),console.log(GRID.finiteArea)):(console.log(e.data),0<e.data[2].length&&writePattern.apply(void 0,_toConsumableArray(e.data).concat([GRID]))),render()}),socket&&socket.on("deleteConnection",function(e){delete clientList[e],render()}),socket&&socket.on("relayPan",function(e){clientList[e.id].xPosition=e.xPosition,clientList[e.id].yPosition=e.yPosition,render()}),socket&&socket.on("relayZoom",function(e){clientList[e.id].zoom=e.zoom,render()}),socket&&socket.on("relayDraw",function(e,t){if(console.log(t),null===resetEvent)for(var n=0;n<t.length;n++)writePattern(t[n].x,t[n].y,[[t[n].newState]],GRID);else for(var r=0;r<t.length;r++)writePattern(t[r].x,t[r].y,[[t[r].newState]],resetEvent);render()}),socket&&socket.on("relayUndoDraw",function(e,t){if(console.log(t),null===resetEvent)for(var n=0;n<t.length;n++)writePattern(t[n].x,t[n].y,[[t[n].oldState]],GRID);else for(var r=0;r<t.length;r++)writePattern(t[r].x,t[r].y,[[t[r].oldState]],resetEvent);render()}),socket&&socket.on("relayPaste",function(e,t){console.log(t),null===resetEvent?writePattern.apply(void 0,_toConsumableArray(t.newPatt).concat([GRID])):writePattern.apply(void 0,_toConsumableArray(t.newPatt).concat([resetEvent])),render()}),socket&&socket.on("relayUndoPaste",function(e,t){console.log(t),null===resetEvent?writePattern.apply(void 0,_toConsumableArray(t.oldPatt).concat([GRID])):writePattern.apply(void 0,_toConsumableArray(t.newPatt).concat([resetEvent])),render()}),socket&&socket.on("relayRule",function(e){e!==rulestring&&(setRule(e),resetHashtable(),document.getElementById("rule").value=e,alert("rule changed to: "+e))}),socket&&socket.on("relayChangeGrid",function(e){var t=exportPattern();GRID.type=e,console.log("importGridPattern"),importPattern(t.pattern,t.xOffset,t.yOffset),render()});